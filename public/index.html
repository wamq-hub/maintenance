<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نظام إدارة الصيانة</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  direction: rtl;
}

/* Loading & Sync Indicator */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.sync-indicator {
  position: fixed;
  top: 80px;
  left: 20px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 1000;
  font-size: 0.9rem;
}

.sync-indicator.syncing {
  display: flex;
  color: #667eea;
}

.sync-indicator.success {
  display: flex;
  color: #27ae60;
}

.sync-indicator.error {
  display: flex;
  color: #e74c3c;
}

.sync-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Login Screen */
.login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.login-box h1 {
  color: #667eea;
  margin-bottom: 10px;
  font-size: 2rem;
}

.login-box .subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 0.95rem;
}

.logo-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 20px;
  text-align: right;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  margin-top: 10px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.sheets-config {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid #eee;
  text-align: right;
}

.sheets-config h4 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 1rem;
}

.sheets-config small {
  display: block;
  color: #888;
  margin-top: 8px;
  line-height: 1.5;
}

/* User Info Bar */
.user-info-bar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px 30px;
  display: none;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-avatar {
  width: 45px;
  height: 45px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

/* Container */
.container {
  max-width: 1400px;
  margin: 20px auto;
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: none;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.2rem;
  margin-bottom: 10px;
}

.header p {
  opacity: 0.9;
  font-size: 1.05rem;
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
  overflow-x: auto;
}

.nav-tab {
  flex: 1;
  padding: 18px 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  color: #666;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.nav-tab:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
}

.nav-tab.active {
  color: #667eea;
  background: white;
}

.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Content */
.tab-content {
  display: none;
  padding: 30px;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Form Styling */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.form-group {
  text-align: right;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

/* Image Upload */
.image-upload-container {
  border: 2px dashed #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.image-upload-container:hover {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.image-upload-container.has-image {
  border-style: solid;
  border-color: #27ae60;
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 10px;
  color: #667eea;
}

.upload-text {
  color: #666;
  font-size: 0.95rem;
}

.image-preview {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  margin-top: 15px;
  display: none;
}

.image-preview.show {
  display: block;
}

.remove-image-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  display: none;
}

.remove-image-btn.show {
  display: inline-block;
}

.remove-image-btn:hover {
  background: #c0392b;
}

/* Buttons */
.btn-primary {
  padding: 12px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  padding: 12px 30px;
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-secondary:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.stat-card p {
  font-size: 1.1rem;
  opacity: 0.9;
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

th {
  padding: 15px;
  text-align: right;
  font-weight: 600;
  font-size: 0.95rem;
}

td {
  padding: 15px;
  text-align: right;
  border-bottom: 1px solid #f0f0f0;
}

tbody tr:hover {
  background: #f8f9ff;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-progress {
  background: #cfe2ff;
  color: #084298;
}

.status-completed {
  background: #d1e7dd;
  color: #0a3622;
}

.status-rejected {
  background: #f8d7da;
  color: #721c24;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}

.action-btn:hover {
  transform: scale(1.05);
}

.btn-view {
  background: #667eea;
  color: white;
}

.btn-edit {
  background: #38ef7d;
  color: white;
}

.btn-delete {
  background: #f45c43;
  color: white;
}

.btn-pdf {
  background: #e74c3c;
  color: white;
}

.btn-excel {
  background: #27ae60;
  color: white;
}

.btn-image {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-header h2 {
  color: #667eea;
  font-size: 1.8rem;
}

.close-modal {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.close-modal:hover {
  color: #333;
}

/* Alert Messages */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-weight: 500;
  display: none;
  animation: slideDown 0.3s;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}

.alert-success {
  background: #d1e7dd;
  color: #0a3622;
  border: 1px solid #a3cfbb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f1aeb5;
}

.alert-info {
  background: #cfe2ff;
  color: #084298;
  border: 1px solid #9ec5fe;
}

/* Image Modal */
.image-modal-content {
  max-width: 90vw;
  max-height: 90vh;
}

.image-modal-content img {
  width: 100%;
  height: auto;
  border-radius: 10px;
}

/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 1.6rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .modal-content {
    padding: 20px;
  }

  .action-buttons {
    flex-direction: column;
  }

  table {
    font-size: 0.85rem;
  }

  th, td {
    padding: 10px 8px;
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #5568d3;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <p style="margin-top: 20px; font-size: 1.2rem;">جاري تحميل النظام...</p>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-spinner"></div>
  <span id="syncText">جاري المزامنة...</span>
</div>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo-icon">🔧</div>
    <h1>نظام إدارة الصيانة</h1>
    <p class="subtitle">مرحباً بك في نظام إدارة طلبات الصيانة</p>
    
    <form id="loginForm" onsubmit="login(event)">
      <div class="input-group">
        <label>الرقم الوظيفي</label>
        <input type="text" id="employeeId" placeholder="أدخل الرقم الوظيفي" required>
      </div>
      
      <div class="input-group">
        <label>كلمة المرور</label>
        <input type="password" id="password" placeholder="أدخل كلمة المرور" required>
      </div>
      
      <button type="submit" class="btn" id="loginBtn">تسجيل الدخول</button>
    </form>
    
    <div class="sheets-config">
      <h4>⚙️ إعدادات Google Sheets</h4>
      <div class="input-group">
        <label>رابط Google Apps Script</label>
        <input type="url" id="appsScriptUrl" 
               placeholder="https://script.google.com/macros/s/..."
               value="">
      </div>
      <small>
        📝 اتبع التعليمات في ملف SETUP.md لإنشاء Google Sheets والحصول على الرابط
      </small>
    </div>
  </div>
</div>

<!-- User Info Bar -->
<div class="user-info-bar" id="userBar">
  <div class="user-info">
    <div class="user-avatar">👤</div>
    <div>
      <div id="userName" style="font-weight: 600; font-size: 1.1rem;"></div>
      <div id="userRole" style="opacity: 0.9; font-size: 0.9rem;"></div>
    </div>
  </div>
  <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer">
  <div class="header">
    <h1>🔧 نظام إدارة الصيانة</h1>
    <p>إدارة شاملة لطلبات الصيانة والأعطال</p>
  </div>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('new-request')">📝 طلب جديد</button>
    <button class="nav-tab" onclick="showTab('technician-report')">🔧 تقرير الفني</button>
    <button class="nav-tab" onclick="showTab('supervisor-review')">✅ مراجعة المشرف</button>
    <button class="nav-tab" onclick="showTab('client-feedback')">⭐ تقييم العميل</button>
    <button class="nav-tab" onclick="showTab('quality-report')">📊 تقرير الجودة</button>
    <button class="btn-secondary" onclick="pullFromSheets()">⬇️ سحب من Google Sheets</button>
    <button class="btn-secondary" onclick="clearLocalRequestsCache()">🧹 مسح النسخة المحلية</button>

  </div>

  <!-- Tab: New Request -->
  <div class="tab-content active" id="new-request">
    <h2 style="color: #667eea; margin-bottom: 25px;">📝 نموذج طلب صيانة جديد</h2>
    
    <div class="alert alert-success" id="newRequestAlert"></div>
    
    <form id="newRequestForm" onsubmit="submitNewRequest(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>رقم الطلب</label>
          <input type="text" id="requestId" disabled>
        </div>
        
        <div class="form-group">
          <label>نوع الطلب</label>
          <select id="requestType" required>
            <option value="">اختر نوع الطلب</option>
            <option value="الكتروني">الكتروني</option>
            <option value="هاتف">هاتف</option>
            <option value="ايميل">ايميل</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>المبنى</label>
          <input type="text" id="building" placeholder="مثال: مبنى الإدارة - الدور الأول" required>
        </div>
        
        <div class="form-group">
          <label>نوع الصيانة</label>
          <select id="maintenanceType" required>
            <option value="">اختر نوع الصيانة</option>
            <option value="صيانة طارئة">صيانة طارئة</option>
            <option value="صيانة وقائية">صيانة وقائية</option>
            <option value="صيانة دورية">صيانة دورية</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>اسم صاحب الطلب</label>
          <input type="text" id="requesterName" placeholder="الاسم الكامل" required>
        </div>
        
        <div class="form-group">
          <label>الوقت</label>
          <input type="text" id="requestTime" disabled>
        </div>
        
        <div class="form-group">
          <label>التاريخ الميلادي</label>
          <input type="text" id="requestDate" disabled>
        </div>
        
        <div class="form-group">
          <label>التاريخ الهجري</label>
          <input type="text" id="hijriDate" disabled>
        </div>
        
        <div class="form-group">
          <label>اليوم</label>
          <input type="text" id="requestDay" disabled>
        </div>
        
        <div class="form-group">
          <label>نوع العطل</label>
          <select id="faultType" onchange="toggleOtherFault()" required>
            <option value="">اختر نوع العطل</option>
            <option value="كهربائي">كهربائي</option>
            <option value="تكييف">تكييف</option>
            <option value="سباكة">سباكة</option>
            <option value="الكترونيات">الكترونيات</option>
            <option value="أخرى">أخرى</option>
          </select>
        </div>
        
        <div class="form-group hidden" id="otherFaultDiv">
          <label>حدد نوع العطل</label>
          <input type="text" id="otherFault" placeholder="اكتب نوع العطل">
        </div>
      </div>
      
      <div class="form-group">
        <label>وصف العطل</label>
        <textarea id="faultDescription" placeholder="اكتب وصفاً تفصيلياً للعطل..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>📷 صورة العطل (اختياري)</label>
        <div class="image-upload-container" id="uploadContainer" onclick="document.getElementById('imageUpload').click()">
          <div class="upload-icon">📸</div>
          <div class="upload-text">اضغط هنا لرفع صورة العطل</div>
          <div class="upload-text" style="font-size: 0.85rem; color: #999; margin-top: 5px;">
            (JPG, PNG, GIF - حد أقصى 2MB)
          </div>
          <img id="imagePreview" class="image-preview" alt="معاينة الصورة">
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
          <button type="button" class="remove-image-btn" id="removeImageBtn" onclick="event.stopPropagation(); removeImage()">
            ❌ إزالة الصورة
          </button>
        </div>
      </div>
      
      <button type="submit" class="btn-primary" id="submitRequestBtn">إرسال الطلب</button>
      <button type="reset" class="btn-secondary" onclick="resetForm()">إعادة تعيين</button>
    </form>
  </div>

  <!-- Tab: Technician Report -->
  <div class="tab-content" id="technician-report">
    <h2 style="color: #667eea; margin-bottom: 25px;">🔧 تقرير الفني</h2>
    
    <div class="alert alert-success" id="technicianAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>صاحب الطلب</th>
            <th>نوع العطل</th>
            <th>المبنى</th>
            <th>التاريخ</th>
            <th>صورة</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="pendingRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Supervisor Review -->
  <div class="tab-content" id="supervisor-review">
    <h2 style="color: #667eea; margin-bottom: 25px;">✅ مراجعة المشرف</h2>
    
    <div class="alert alert-success" id="supervisorAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>صاحب الطلب</th>
            <th>نوع العطل</th>
            <th>اسم الفني</th>
            <th>التاريخ</th>
            <th>صورة</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="technicianReportsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Client Feedback -->
  <div class="tab-content" id="client-feedback">
    <h2 style="color: #667eea; margin-bottom: 25px;">⭐ تقييم العميل</h2>
    
    <div class="alert alert-success" id="clientAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>صاحب الطلب</th>
            <th>نوع العطل</th>
            <th>التاريخ</th>
            <th>صورة</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="approvedRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Quality Report -->
  <div class="tab-content" id="quality-report">
    <h2 style="color: #667eea; margin-bottom: 25px;">📊 تقرير الجودة والإحصائيات</h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalRequests">0</h3>
        <p>إجمالي الطلبات</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingRequests">0</h3>
        <p>طلبات معلقة</p>
      </div>
      <div class="stat-card">
        <h3 id="completedRequests">0</h3>
        <p>طلبات مكتملة</p>
      </div>
      <div class="stat-card">
        <h3 id="rejectedRequests">0</h3>
        <p>طلبات مرفوضة</p>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <button class="btn-primary btn-excel" onclick="exportToExcel()">📊 تصدير Excel</button>
      <button class="btn-primary btn-success" onclick="exportAllWithTemplates()">📋 تصدير الكل بالنموذج</button>
      <button class="btn-primary btn-pdf" onclick="exportToPDF()">📄 تصدير PDF</button>
      <button class="btn-secondary" onclick="syncWithSheets()">🔄 مزامنة مع Google Sheets</button>
      <button class="btn-secondary" onclick="printReport()">🖨️ طباعة</button>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>رقم الطلب</th>
            <th>صاحب الطلب</th>
            <th>نوع العطل</th>
            <th>المبنى</th>
            <th>التاريخ</th>
            <th>الفني</th>
            <th>المشرف</th>
            <th>صورة</th>
            <th>الحالة</th>
            <th>التقييم</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody id="allRequestsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modals will be added here by JavaScript -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Global Variables
let currentUser = null;
let requests = [];
let users = [];
let appsScriptUrl = '';
let uploadedImage = null;

// User Roles
const ROLES = {
  QUALITY_MANAGER: 'وكيل ضبط الجودة',
  SUPERVISOR: 'مشرف الصيانة',
  TECHNICIAN: 'فني الصيانة',
  EMPLOYEE: 'موظف',
  DEAN: 'العميد'
};

// Hijri Conversion
function toHijri(gregorianDate) {
  const gDate = new Date(gregorianDate);
  const gYear = gDate.getFullYear();
  const gMonth = gDate.getMonth() + 1;
  const gDay = gDate.getDate();
  
  const hYear = Math.floor((gYear - 622) * 1.030684);
  const hMonth = Math.floor((gMonth + (gDay / 30)) * 1.030684) % 12 || 12;
  const hDay = Math.floor((gDay * 1.030684) % 30) || 1;
  
  const arabicMonths = [
    'محرم', 'صفر', 'ربيع الأول', 'ربيع الثاني', 'جمادى الأولى', 'جمادى الثانية',
    'رجب', 'شعبان', 'رمضان', 'شوال', 'ذو القعدة', 'ذو الحجة'
  ];
  
  return `${hDay} ${arabicMonths[hMonth - 1]} ${hYear}هـ`;
}

// Get Arabic Day
function getArabicDay(date) {
  const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
  return days[new Date(date).getDay()];
}

// Initialize
window.onload = function() {
  // Load saved Apps Script URL
  const savedUrl = localStorage.getItem('appsScriptUrl');
  if (savedUrl) {
    document.getElementById('appsScriptUrl').value = savedUrl;
    appsScriptUrl = savedUrl;
  }
  
  loadRequestsFromStorage();
  updateNextRequestId();
  setCurrentDateTime();
  
  // Check if user already logged in
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser && appsScriptUrl) {
    currentUser = JSON.parse(savedUser);
    showMainApp();
  }
  
  // Hide loading screen
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 1000);
  
  // Create modals
  createModals();
};

// Create Modals
function createModals() {
  const modalsHTML = `
    <!-- Technician Report Modal -->
    <div class="modal" id="technicianModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>🔧 تقرير الفني</h2>
          <button class="close-modal" onclick="closeModal('technicianModal')">&times;</button>
        </div>
        
        <form id="technicianForm" onsubmit="submitTechnicianReport(event)">
          <input type="hidden" id="techRequestId">
          
          <div class="form-group">
            <label>اسم الفني</label>
            <input type="text" id="technicianName" required>
          </div>
          
          <div class="form-group">
            <label>حالة العمل</label>
            <select id="workStatus" required>
              <option value="">اختر الحالة</option>
              <option value="تم الإصلاح">تم الإصلاح</option>
              <option value="جاري الإصلاح">جاري الإصلاح</option>
              <option value="تحت المعالجة">تحت المعالجة</option>
              <option value="يحتاج قطع غيار">يحتاج قطع غيار</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ملاحظات الفني</label>
            <textarea id="technicianNotes" placeholder="أضف أي ملاحظات هنا..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">حفظ التقرير</button>
          <button type="button" class="btn-secondary" onclick="closeModal('technicianModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- Supervisor Review Modal -->
    <div class="modal" id="supervisorModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>✅ مراجعة المشرف</h2>
          <button class="close-modal" onclick="closeModal('supervisorModal')">&times;</button>
        </div>
        
        <form id="supervisorForm" onsubmit="submitSupervisorReview(event)">
          <input type="hidden" id="supRequestId">
          
          <div class="form-group">
            <label>اسم المشرف</label>
            <input type="text" id="supervisorName" required>
          </div>
          
          <div class="form-group">
            <label>قرار المشرف</label>
            <select id="supervisorDecision" required>
              <option value="">اختر القرار</option>
              <option value="معتمد">معتمد</option>
              <option value="مرفوض">مرفوض</option>
              <option value="يحتاج مراجعة">يحتاج مراجعة</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ملاحظات المشرف</label>
            <textarea id="supervisorNotes" placeholder="أضف ملاحظاتك هنا..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">حفظ المراجعة</button>
          <button type="button" class="btn-secondary" onclick="closeModal('supervisorModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- Client Feedback Modal -->
    <div class="modal" id="clientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>⭐ تقييم العميل</h2>
          <button class="close-modal" onclick="closeModal('clientModal')">&times;</button>
        </div>
        
        <form id="clientForm" onsubmit="submitClientFeedback(event)">
          <input type="hidden" id="clientRequestId">
          
          <div class="form-group">
            <label>هل تم إصلاح العطل؟</label>
            <select id="isFixed" required>
              <option value="">اختر</option>
              <option value="نعم">نعم</option>
              <option value="لا">لا</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>مستوى الرضا</label>
            <select id="satisfactionLevel" required>
              <option value="">اختر مستوى الرضا</option>
              <option value="ممتاز">ممتاز ⭐⭐⭐⭐⭐</option>
              <option value="جيد جداً">جيد جداً ⭐⭐⭐⭐</option>
              <option value="جيد">جيد ⭐⭐⭐</option>
              <option value="مقبول">مقبول ⭐⭐</option>
              <option value="ضعيف">ضعيف ⭐</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>ملاحظات العميل</label>
            <textarea id="clientNotes" placeholder="أضف ملاحظاتك أو اقتراحاتك..."></textarea>
          </div>
          
          <button type="submit" class="btn-primary">إرسال التقييم</button>
          <button type="button" class="btn-secondary" onclick="closeModal('clientModal')">إلغاء</button>
        </form>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>📋 تفاصيل الطلب</h2>
          <button class="close-modal" onclick="closeModal('viewModal')">&times;</button>
        </div>
        <div id="viewDetailsContent"></div>
        <button class="btn-secondary" onclick="closeModal('viewModal')">إغلاق</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
      <div class="modal-content image-modal-content">
        <div class="modal-header">
          <h2>📷 صورة العطل</h2>
          <button class="close-modal" onclick="closeModal('imageModal')">&times;</button>
        </div>
        <img id="modalImage" style="width: 100%; height: auto; border-radius: 10px;" alt="صورة العطل">
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalsHTML);
}

// Handle Image Upload
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check file size (max 2MB)
  if (file.size > 2 * 1024 * 1024) {
    alert('❌ حجم الصورة كبير جداً. الحد الأقصى 2 ميجابايت');
    return;
  }
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('❌ الملف المختار ليس صورة');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedImage = e.target.result;
    document.getElementById('imagePreview').src = uploadedImage;
    document.getElementById('imagePreview').classList.add('show');
    document.getElementById('removeImageBtn').classList.add('show');
    document.getElementById('uploadContainer').classList.add('has-image');
  };
  reader.readAsDataURL(file);
}

// Remove Image
function removeImage() {
  uploadedImage = null;
  document.getElementById('imageUpload').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('removeImageBtn').classList.remove('show');
  document.getElementById('uploadContainer').classList.remove('has-image');
}

// View Image
function viewImage(imageData) {
  if (!imageData) {
    alert('لا توجد صورة');
    return;
  }
  document.getElementById('modalImage').src = imageData;
  document.getElementById('imageModal').classList.add('active');
}

// Google Sheets Integration
async function callAppsScript(action, data) {
  if (!appsScriptUrl) return null;

  showSyncIndicator('syncing');
  try {
    const res = await fetch(appsScriptUrl, {
      method: 'POST',
      // ملاحظة: لا تضف Content-Type: application/json عشان نتجنب preflight
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action, data })
    });

    if (!res.ok) {
      const text = await res.text();
      console.error('HTTP', res.status, text);
      showSyncIndicator('error');
      alert(`فشل الطلب: ${res.status}`);
      return null;
    }

    const json = await res.json();  // Apps Script يرجع JSON عبر ContentService
    showSyncIndicator((json && (json.ok === false || json.success === false)) ? 'error' : 'success');
    return json;
  } catch (err) {
    console.error('Fetch error:', err);
    showSyncIndicator('error');
    alert('تعذّر السحب (تحقق من /exec والصلاحيات). التفاصيل في Console.');
    return null;
  }
}

// يحوّل صفوف الشيت (رؤوس عربية) إلى نموذج الواجهة (مفاتيح إنجليزية)
function normalizeDriveImageUrl(url) {
  if (!url) return '';
  // أنماط روابط Drive الشائعة
  const byFile = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  const byOpen = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
  const byUc   = url.match(/drive\.google\.com\/uc\?id=([^&]+)/);
  const id = (byFile?.[1]) || (byOpen?.[1]) || (byUc?.[1]) || null;
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
}

// ===== helpers for Drive images =====

// يستخرج fileId من أي شكل رابط Drive
function extractDriveId(url){
  if (!url) return null;
  const byFile = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  const byOpen = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
  const byUc   = url.match(/drive\.google\.com\/uc\?(?:export=\w+&)?id=([^&]+)/);
  return (byFile?.[1]) || (byOpen?.[1]) || (byUc?.[1]) || null;
}

// يطلب من Apps Script تحويل صورة Drive إلى dataURL (Base64)
// يتطلب إضافة أكشن getImageBase64 في السكربت (انظر القسم 3 بالأسفل)
async function getDriveImageAsDataURL(url){
  const id = extractDriveId(url);
  if (!id) return null;
  const res = await callAppsScript('getImageBase64', { fileId: id });
  return (res && res.success && res.dataUrl) ? res.dataUrl : null;
}

// بديل احتياطي داخل المتصفح (قد يفشل بسبب CORS مع روابط Drive)
async function urlToDataURL(url) {
  const res = await fetch(url);  // قد يرمي CORS
  const blob = await res.blob();
  return await new Promise((resolve) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result); // data:image/...;base64,...
    fr.readAsDataURL(blob);
  });
}

function mapArabicRowToModel(ar) {
  const rawUrl = ar['رابط الصورة'] || '';
  return {
    id: (ar['رقم الطلب'] || '').toString(),
    type: ar['نوع الطلب'] || '',
    building: ar['المبنى'] || '',
    maintenanceType: ar['نوع الصيانة'] || '',
    requesterName: ar['اسم صاحب الطلب'] || '',
    time: ar['الوقت'] || '',
    date: ar['التاريخ'] || '',
    hijriDate: ar['التاريخ الهجري'] || '',
    day: ar['اليوم'] || '',
    faultType: ar['نوع العطل'] || '',
    faultDescription: ar['وصف العطل'] || '',
    imageUrl: normalizeDriveImageUrl(rawUrl), // ← هنا
    status: ar['الحالة'] || 'معلق',
    technicianName: ar['اسم الفني'] || '',
    workStatus: ar['حالة العمل'] || '',
    technicianNotes: ar['ملاحظات الفني'] || '',
    supervisorName: ar['اسم المشرف'] || '',
    supervisorDecision: ar['قرار المشرف'] || '',
    supervisorNotes: ar['ملاحظات المشرف'] || '',
    isFixed: ar['تم الإصلاح'] || '',
    satisfactionLevel: ar['مستوى الرضا'] || '',
    clientNotes: ar['ملاحظات العميل'] || '',
    createdAt: ar['تاريخ الإنشاء'] || ''
  };
}



// Show Sync Indicator
function showSyncIndicator(status) {
  const indicator = document.getElementById('syncIndicator');
  const text = document.getElementById('syncText');

  // أظهر المؤشّر دائمًا أولًا
  indicator.style.display = 'flex';
  indicator.className = 'sync-indicator ' + status;

  if (status === 'syncing') {
    text.textContent = 'جاري المزامنة...';
  } else if (status === 'success') {
    text.textContent = '✓ تمت المزامنة بنجاح';
  } else if (status === 'error') {
    text.textContent = '✗ فشلت المزامنة';
  }

  // أخفِه بعد 3 ثوانٍ في حال success/error فقط
  if (status !== 'syncing') {
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 3000);
  }
}


// Sync with Sheets
async function syncWithSheets() {
  if (!appsScriptUrl) {
    alert('⚠️ يجب تكوين رابط Google Apps Script أولاً');
    return;
  }
  
  showSyncIndicator('syncing');
  
  // Save all requests to Sheets
  for (const request of requests) {
    await callAppsScript('addRequest', request);
  }
  
  alert('✓ تمت المزامنة مع Google Sheets بنجاح!');
}

async function pullFromSheets() {
  if (!appsScriptUrl) {
    alert('⚠️ اضبط رابط Google Apps Script أولاً');
    return;
  }
  showNotification('جاري السحب من Google Sheets...', 'info');

  const res = await callAppsScript('getRequests', {});
  if (!res) { alert('تعذّر السحب'); return; }

  // السكربت يعيد {success:true, data:[...]}
  const rows = (res.data || []);
  if (!Array.isArray(rows)) {
    alert('صيغة بيانات غير متوقعة من الشيت');
    return;
  }

  // تحويل الرؤوس العربية إلى نموذج الواجهة
  requests = rows.map(mapArabicRowToModel);

  saveRequestsToStorage();
  refreshAllTables();
  showNotification(`تم السحب، وعدد الطلبات: ${requests.length}`, 'success');
}



// Login
async function login(e) {
  e.preventDefault();
  
  const employeeId = document.getElementById('employeeId').value;
  const password = document.getElementById('password').value;
  const scriptUrl = document.getElementById('appsScriptUrl').value;
  
  if (!scriptUrl) {
    alert('⚠️ يجب إدخال رابط Google Apps Script');
    return;
  }
  
  // Save Apps Script URL
  appsScriptUrl = scriptUrl;
  localStorage.setItem('appsScriptUrl', scriptUrl);
  
  // Disable login button
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'جاري التحقق...';
  
  try {
    // Try to fetch users from Sheets
    // Note: In real implementation, you'd make actual API call
    // For now, we'll use demo users
    
    const demoUsers = [
      { id: '000001', password: 'quality123', name: 'م. فهد صالح', role: ROLES.QUALITY_MANAGER },
      { id: '000002', password: 'supervisor123', name: 'أحمد محمد', role: ROLES.SUPERVISOR },
      { id: '000003', password: 'technician123', name: 'خالد علي', role: ROLES.TECHNICIAN },
      { id: '000004', password: 'employee123', name: 'سارة أحمد', role: ROLES.EMPLOYEE },
      { id: '000005', password: 'dean123', name: 'د. محمد العتيبي', role: ROLES.DEAN }
    ];
    
    const user = demoUsers.find(u => u.id === employeeId && u.password === password);
    
    if (user) {
      currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(user));
      showMainApp();
    } else {
      alert('❌ الرقم الوظيفي أو كلمة المرور غير صحيحة');
      loginBtn.disabled = false;
      loginBtn.textContent = 'تسجيل الدخول';
    }
  } catch (error) {
    console.error('Login error:', error);
    alert('❌ حدث خطأ أثناء تسجيل الدخول');
    loginBtn.disabled = false;
    loginBtn.textContent = 'تسجيل الدخول';
  }
}

// Logout
function logout() {
  if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
  }
}

// Show Main App
function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('mainContainer').style.display = 'block';
  
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userRole').textContent = currentUser.role;
  
  setupPermissions();
  refreshAllTables();
}

// Setup Permissions
function setupPermissions() {
  const tabs = document.querySelectorAll('.nav-tab');
  
  tabs.forEach(tab => tab.style.display = 'none');
  
  if (currentUser.role === ROLES.QUALITY_MANAGER || currentUser.role === ROLES.DEAN) {
    tabs.forEach(tab => tab.style.display = 'block');
  } else if (currentUser.role === ROLES.SUPERVISOR) {
    ['new-request', 'supervisor-review', 'quality-report'].forEach(tabId => {
      document.querySelector(`[onclick="showTab('${tabId}')"]`).style.display = 'block';
    });
    showTab('supervisor-review');
  } else if (currentUser.role === ROLES.TECHNICIAN) {
    document.querySelector(`[onclick="showTab('technician-report')"]`).style.display = 'block';
    showTab('technician-report');
  } else if (currentUser.role === ROLES.EMPLOYEE) {
    ['new-request', 'client-feedback'].forEach(tabId => {
      document.querySelector(`[onclick="showTab('${tabId}')"]`).style.display = 'block';
    });
  }
}

// Show Tab
function showTab(tabId) {
  document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tabId).classList.add('active');
  
  refreshAllTables();
}

// Set Current DateTime
function setCurrentDateTime() {
  const now = new Date();
  const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('ar-SA');
  const hijri = toHijri(now);
  const day = getArabicDay(now);
  
  document.getElementById('requestTime').value = time;
  document.getElementById('requestDate').value = date;
  document.getElementById('hijriDate').value = hijri;
  document.getElementById('requestDay').value = day;
}

// Update Request ID
function updateNextRequestId() {
  const nextId = (requests.length + 1).toString().padStart(6, '0');
  document.getElementById('requestId').value = nextId;
}

// Toggle Other Fault
function toggleOtherFault() {
  const faultType = document.getElementById('faultType').value;
  const otherDiv = document.getElementById('otherFaultDiv');
  
  if (faultType === 'أخرى') {
    otherDiv.classList.remove('hidden');
    document.getElementById('otherFault').required = true;
  } else {
    otherDiv.classList.add('hidden');
    document.getElementById('otherFault').required = false;
  }
}

// Reset Form
function resetForm() {
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
}

// Submit New Request
async function submitNewRequest(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitRequestBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'جاري الإرسال...';
  
  const faultType = document.getElementById('faultType').value;
  const finalFaultType = faultType === 'أخرى' ? document.getElementById('otherFault').value : faultType;
  
  const request = {
    id: document.getElementById('requestId').value,
    type: document.getElementById('requestType').value,
    building: document.getElementById('building').value,
    maintenanceType: document.getElementById('maintenanceType').value,
    requesterName: document.getElementById('requesterName').value,
    time: document.getElementById('requestTime').value,
    date: document.getElementById('requestDate').value,
    hijriDate: document.getElementById('hijriDate').value,
    day: document.getElementById('requestDay').value,
    faultType: finalFaultType,
    faultDescription: document.getElementById('faultDescription').value,
    image: uploadedImage || '',
    status: 'معلق',
    createdAt: new Date().toISOString(),
    createdBy: currentUser.name
  };
  
  requests.push(request);
  saveRequestsToStorage();
  
  // Send to Google Sheets
  const addRes = await callAppsScript('addRequest', request);
    // إذا أعاد السكربت رابط الصورة من Drive، خزّنه بدلاً من الـbase64 الثقيلة
    if (addRes && addRes.imageUrl) {
      request.imageUrl = addRes.imageUrl;
      request.image = ''; // تفاديًا لتخزين base64 محليًا
      saveRequestsToStorage();
    }

  
  showAlert('newRequestAlert', 'تم إرسال الطلب بنجاح! رقم الطلب: ' + request.id, 'success');
  
  document.getElementById('newRequestForm').reset();
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'إرسال الطلب';
  
  setTimeout(() => {
    document.getElementById('newRequestAlert').style.display = 'none';
  }, 5000);
}

// Open Technician Modal
function openTechnicianModal(requestId) {
  document.getElementById('techRequestId').value = requestId;
  document.getElementById('technicianName').value = currentUser.name;
  document.getElementById('technicianModal').classList.add('active');
}

// Submit Technician Report
async function submitTechnicianReport(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('techRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.technicianName = document.getElementById('technicianName').value;
    request.workStatus = document.getElementById('workStatus').value;
    request.technicianNotes = document.getElementById('technicianNotes').value;
    request.status = 'جاري المراجعة';
    request.techUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('technicianModal');
    showAlert('technicianAlert', 'تم حفظ التقرير بنجاح!', 'success');
    refreshAllTables();
    
    document.getElementById('technicianForm').reset();
    
    setTimeout(() => {
      document.getElementById('technicianAlert').style.display = 'none';
    }, 3000);
  }
}

// Open Supervisor Modal
function openSupervisorModal(requestId) {
  document.getElementById('supRequestId').value = requestId;
  document.getElementById('supervisorName').value = currentUser.name;
  document.getElementById('supervisorModal').classList.add('active');
}

// Submit Supervisor Review
async function submitSupervisorReview(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('supRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.supervisorName = document.getElementById('supervisorName').value;
    request.supervisorDecision = document.getElementById('supervisorDecision').value;
    request.supervisorNotes = document.getElementById('supervisorNotes').value;
    
    if (request.supervisorDecision === 'معتمد') {
      request.status = 'معتمد';
    } else if (request.supervisorDecision === 'مرفوض') {
      request.status = 'مرفوض';
    } else {
      request.status = 'يحتاج مراجعة';
    }
    
    request.supUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('supervisorModal');
    showAlert('supervisorAlert', 'تم حفظ المراجعة بنجاح!', 'success');
    refreshAllTables();
    
    document.getElementById('supervisorForm').reset();
    
    setTimeout(() => {
      document.getElementById('supervisorAlert').style.display = 'none';
    }, 3000);
  }
}

// Open Client Modal
function openClientModal(requestId) {
  document.getElementById('clientRequestId').value = requestId;
  document.getElementById('clientModal').classList.add('active');
}

// Submit Client Feedback
async function submitClientFeedback(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('clientRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.isFixed = document.getElementById('isFixed').value;
    request.satisfactionLevel = document.getElementById('satisfactionLevel').value;
    request.clientNotes = document.getElementById('clientNotes').value;
    request.status = request.isFixed === 'نعم' ? 'مكتمل' : 'غير مكتمل';
    request.clientUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('clientModal');
    showAlert('clientAlert', 'تم إرسال التقييم بنجاح! شكراً لك', 'success');
    refreshAllTables();
    
    document.getElementById('clientForm').reset();
    
    setTimeout(() => {
      document.getElementById('clientAlert').style.display = 'none';
    }, 3000);
  }
}

// View Request Details
function viewRequest(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;
  
  let html = '<div style="text-align: right;">';
  html += '<h3 style="color: #667eea; margin-bottom: 20px;">معلومات الطلب الأساسية</h3>';
  html += `<p><strong>رقم الطلب:</strong> ${request.id}</p>`;
  html += `<p><strong>نوع الطلب:</strong> ${request.type}</p>`;
  html += `<p><strong>المبنى:</strong> ${request.building}</p>`;
  html += `<p><strong>نوع الصيانة:</strong> ${request.maintenanceType}</p>`;
  html += `<p><strong>صاحب الطلب:</strong> ${request.requesterName}</p>`;
  html += `<p><strong>التاريخ:</strong> ${request.date} - ${request.hijriDate}</p>`;
  html += `<p><strong>الوقت:</strong> ${request.time}</p>`;
  html += `<p><strong>اليوم:</strong> ${request.day}</p>`;
  html += `<p><strong>نوع العطل:</strong> ${request.faultType}</p>`;
  html += `<p><strong>وصف العطل:</strong> ${request.faultDescription}</p>`;
  
const _img = request.imageUrl || request.image;
if (_img) {
  html += `<p><strong>صورة العطل:</strong><br><img src="${_img}" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin-top: 10px;" alt="صورة العطل"></p>`;
}

  
  html += `<p><strong>الحالة:</strong> <span class="status-badge status-${getStatusClass(request.status)}">${request.status}</span></p>`;
  
  if (request.technicianName) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">تقرير الفني</h3>';
    html += `<p><strong>اسم الفني:</strong> ${request.technicianName}</p>`;
    html += `<p><strong>حالة العمل:</strong> ${request.workStatus}</p>`;
    html += `<p><strong>ملاحظات الفني:</strong> ${request.technicianNotes}</p>`;
  }
  
  if (request.supervisorName) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">مراجعة المشرف</h3>';
    html += `<p><strong>اسم المشرف:</strong> ${request.supervisorName}</p>`;
    html += `<p><strong>القرار:</strong> ${request.supervisorDecision}</p>`;
    html += `<p><strong>ملاحظات المشرف:</strong> ${request.supervisorNotes}</p>`;
  }
  
  if (request.isFixed) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">تقييم العميل</h3>';
    html += `<p><strong>تم الإصلاح:</strong> ${request.isFixed}</p>`;
    html += `<p><strong>مستوى الرضا:</strong> ${request.satisfactionLevel}</p>`;
    html += `<p><strong>ملاحظات العميل:</strong> ${request.clientNotes || 'لا توجد'}</p>`;
  }
  
  html += '</div>';
  
  document.getElementById('viewDetailsContent').innerHTML = html;
  document.getElementById('viewModal').classList.add('active');
}

// Delete Request
async function deleteRequest(requestId) {
  if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
    requests = requests.filter(r => r.id !== requestId);
    saveRequestsToStorage();
    await callAppsScript('deleteRequest', { id: requestId });
    refreshAllTables();
    alert('تم حذف الطلب بنجاح');
  }
}

// Get Status Class
function getStatusClass(status) {
  const statusMap = {
    'معلق': 'pending',
    'جاري المراجعة': 'progress',
    'معتمد': 'completed',
    'مكتمل': 'completed',
    'مرفوض': 'rejected',
    'غير مكتمل': 'rejected',
    'يحتاج مراجعة': 'progress'
  };
  return statusMap[status] || 'pending';
}

// Refresh All Tables
function refreshAllTables() {
  refreshPendingRequestsTable();
  refreshTechnicianReportsTable();
  refreshApprovedRequestsTable();
  refreshAllRequestsTable();
  updateStatistics();
}

// Refresh Pending Requests Table
function refreshPendingRequestsTable() {
  const tbody = document.getElementById('pendingRequestsTable');
  const pendingRequests = requests.filter(r => r.status === 'معلق');
  
  if (pendingRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات معلقة</td></tr>';
    return;
  }
  
  tbody.innerHTML = pendingRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-pending">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">عرض</button>
          <button class="action-btn btn-edit" onclick="openTechnicianModal('${req.id}')">معالجة</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Technician Reports Table
function refreshTechnicianReportsTable() {
  const tbody = document.getElementById('technicianReportsTable');
  const reportedRequests = requests.filter(r => r.status === 'جاري المراجعة');
  
  if (reportedRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">لا توجد تقارير للمراجعة</td></tr>';
    return;
  }
  
  tbody.innerHTML = reportedRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-progress">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">عرض</button>
          <button class="action-btn btn-edit" onclick="openSupervisorModal('${req.id}')">مراجعة</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Approved Requests Table
function refreshApprovedRequestsTable() {
  const tbody = document.getElementById('approvedRequestsTable');
  const approvedRequests = requests.filter(r => r.status === 'معتمد');
  
  if (approvedRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات معتمدة للتقييم</td></tr>';
    return;
  }
  
  tbody.innerHTML = approvedRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-completed">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">عرض</button>
          <button class="action-btn btn-edit" onclick="openClientModal('${req.id}')">تقييم</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// === Template via relative URL ===
const TEMPLATE_URL = './templates/maintenance_template.xlsx';

// خريطة الحقول ← الخلايا (عدّل الخلايا حسب تمبليتك)
const TEMPLATE_CELL_MAP = {
  'C8':   r => r.id,
  'F8':   r => r.type,
  'I8':   r => r.building,
  'D9':   r => r.maintenanceType,
  'D11':  r => r.requesterName,
  'D13':  r => r.time,
  'H13':  r => r.date,             // الميلادي
  'C15':  r => r.faultType,
  'A19':  r => r.faultDescription,
  'C25':  r => r.technicianName || '',
  'H26':  r => r.techDate || r.date || '',
  'C29':  r => r.supervisorName || '',
  'C30':  r => r.status || '',
  'H31':  r => r.supDate || r.date || '',
  'C34':  r => r.requesterName || '',
  'C35':  r => r.isFixed || '',
  'H36':  r => r.clientDate || r.date || ''
};

// تحميل التمبليت من ملف مجاور (ويُخزّن بالذاكرة)
let __templateArrayBuffer = null;
async function loadTemplateArrayBuffer() {
  if (__templateArrayBuffer) return __templateArrayBuffer;
  const res = await fetch(TEMPLATE_URL);
  if (!res.ok) throw new Error('تعذّر تحميل ملف التمبليت');
  __templateArrayBuffer = await res.arrayBuffer();
  return __templateArrayBuffer;
}

function dataURLToBase64(dataURL) {
  return (dataURL || '').split(',')[1] || '';
}

// تعبئة خلايا النموذج
function fillTemplateCells(ws, request) {
  for (const cell in TEMPLATE_CELL_MAP) {
    const getter = TEMPLATE_CELL_MAP[cell];
    const val = (typeof getter === 'function') ? getter(request) : (request[getter] ?? '');
    const c = ws.getCell(cell);
    c.value = (val == null ? '' : val);
    c.alignment = Object.assign({}, c.alignment, { readingOrder: 'rtl' });
  }
}

// إدراج صورة العطل في نطاق محدد (اضبط المكان حسب تمبليتك)
// إدراج صورة العطل داخل التمبليت (يدعم imageUrl عبر Apps Script)
async function tryInsertFaultImage(wb, ws, request) {
  // نحاول أولاً dataURL المخزّن محليًا
  let dataUrl = request.image || '';
  // إن لم تتوفر وحصلنا على imageUrl من Drive، حوّلها إلى Base64
  if (!dataUrl && request.imageUrl) {
    dataUrl = await getDriveImageAsDataURL(request.imageUrl);
    if (!dataUrl) {
      try { dataUrl = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }
  if (!dataUrl) return; // لا صورة

  try {
    const base64 = (dataUrl.split(',')[1] || '');
    const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'jpeg';
    const imgId = wb.addImage({ base64, extension: ext });
    // عدّل الإحداثيات حسب تمبليتك
    ws.addImage(imgId, { tl: { col: 7, row: 18 }, br: { col: 11, row: 28 } });
  } catch (e) {
    console.warn('تعذّر إدراج الصورة داخل التمبليت:', e);
  }
}



// Refresh All Requests Table
function refreshAllRequestsTable() {
  const tbody = document.getElementById('allRequestsTable');
  
  if (requests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">لا توجد طلبات</td></tr>';
    return;
  }
  
  tbody.innerHTML = requests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${req.technicianName || '-'}</td>
      <td>${req.supervisorName || '-'}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">📷</button>' : '-'}</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>${req.satisfactionLevel || '-'}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">عرض</button>
          <button class="action-btn btn-excel" onclick="exportWithTemplate('${req.id}')" title="تصدير بالنموذج">📋 نموذج</button>
          <button class="action-btn btn-pdf" onclick="exportSinglePDF('${req.id}')">PDF</button>
          <button class="action-btn btn-delete" onclick="deleteRequest('${req.id}')">حذف</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Update Statistics
function updateStatistics() {
  document.getElementById('totalRequests').textContent = requests.length;
  document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'معلق' || r.status === 'جاري المراجعة').length;
  document.getElementById('completedRequests').textContent = requests.filter(r => r.status === 'مكتمل' || r.status === 'معتمد').length;
  document.getElementById('rejectedRequests').textContent = requests.filter(r => r.status === 'مرفوض' || r.status === 'غير مكتمل').length;
}

// Export to Excel
function exportToExcel() {
  if (requests.length === 0) {
    alert('لا توجد بيانات للتصدير');
    return;
  }
  
  const data = requests.map(req => ({
    'رقم الطلب': req.id,
    'صاحب الطلب': req.requesterName,
    'نوع الطلب': req.type,
    'المبنى': req.building,
    'نوع الصيانة': req.maintenanceType,
    'نوع العطل': req.faultType,
    'وصف العطل': req.faultDescription,
    'التاريخ': req.date,
    'التاريخ الهجري': req.hijriDate,
    'الوقت': req.time,
    'اليوم': req.day,
    'اسم الفني': req.technicianName || '-',
    'حالة العمل': req.workStatus || '-',
    'اسم المشرف': req.supervisorName || '-',
    'قرار المشرف': req.supervisorDecision || '-',
    'تم الإصلاح': req.isFixed || '-',
    'مستوى الرضا': req.satisfactionLevel || '-',
    'الحالة النهائية': req.status,
    'يحتوي على صورة': (req.imageUrl || req.image) ? 'نعم' : 'لا'
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'تقرير الصيانة');
  
  const fileName = `تقرير_الصيانة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// Export to PDF
function exportToPDF() {
  if (requests.length === 0) {
    alert('لا توجد بيانات للتصدير');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');
  
  doc.setLanguage('ar');
  doc.setR2L(true);
  
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('🔧', 15, 15);
  
  doc.setFontSize(18);
  doc.setTextColor(0, 0, 0);
  doc.text('تقرير الصيانة الشامل', doc.internal.pageSize.width / 2, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(`التاريخ: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.width - 15, 15, { align: 'right' });
  
  const tableData = requests.map(req => [
    req.id,
    req.requesterName,
    req.faultType,
    req.building,
    req.date,
    req.technicianName || '-',
    req.supervisorName || '-',
    req.status,
    (req.imageUrl || req.image) ? '✓' : '-'
  ]);
  
  doc.autoTable({
    startY: 30,
    head: [['رقم الطلب', 'صاحب الطلب', 'نوع العطل', 'المبنى', 'التاريخ', 'الفني', 'المشرف', 'الحالة', 'صورة']],
    body: tableData,
    styles: {
      font: 'helvetica',
      fontSize: 10,
      halign: 'center'
    },
    headStyles: {
      fillColor: [102, 126, 234],
      textColor: 255,
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [245, 245, 250]
    }
  });
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(
      `صفحة ${i} من ${pageCount}`,
      doc.internal.pageSize.width / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }
  
  const fileName = `تقرير_الصيانة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
}

// Export All Requests with Templates
async function exportAllWithTemplates() {
  if (requests.length === 0) { alert('لا توجد بيانات'); return; }

  showNotification('جاري تجهيز جميع النماذج...', 'info');

  // حمّل التمبليت
  const ab = await loadTemplateArrayBuffer();
  const baseWb = new ExcelJS.Workbook();
  await baseWb.xlsx.load(ab);
  const baseSheet = baseWb.worksheets[0];

  // ملف الإخراج
  const outWb = new ExcelJS.Workbook();

  for (const req of requests) {
    // أضف ورقة جديدة باسم الطلب
    const ws = outWb.addWorksheet(`طلب_${req.id}`.substring(0,31));

    // انسخ هيكل وتنسيقات التمبليت (صفاً بصف)
    baseSheet.eachRow({ includeEmpty: true }, (row, r) => {
      const newRow = ws.getRow(r);
      row.eachCell({ includeEmpty: true }, (cell, c) => {
        const nc = newRow.getCell(c);
        nc.value = cell.value;
        if (cell.style) nc.style = JSON.parse(JSON.stringify(cell.style));
      });
      newRow.height = row.height;
    });
    // انسخ عروض الأعمدة
    if (baseSheet.columns) {
      ws.columns = baseSheet.columns.map(col => ({ width: col.width }));
    }

    // عبّئ خلايا الورقة الجديدة
    fillTemplateCells(ws, req);

    // (اختياري) صورة العطل
    await tryInsertFaultImage(outWb, ws, req);
  }

  // حمّل الملف
  const fileName = `نماذج_الصيانة_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  const outBuf = await outWb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification(`تم تصدير ${requests.length} نموذج من التمبليت!`, 'success');
}

// Export Single Request with Template
async function exportWithTemplate(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) { alert('الطلب غير موجود'); return; }

  showNotification('جاري تجهيز النموذج...', 'info');

  // 1) حمل التمبليت
  const ab = await loadTemplateArrayBuffer();

  // 2) افتح التمبليت
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(ab);

  // 3) اختر الورقة الأولى (أو اسم الورقة لو عندك اسم محدد)
  const ws = wb.worksheets[0]; // أو wb.getWorksheet('نموذج الصيانة');

  // 4) عبّئ الخلايا
  fillTemplateCells(ws, request);

  // 5) (اختياري) أدرج صورة العطل في مكانها
  await tryInsertFaultImage(wb, ws, request);

  // 6) حمّل الملف للمستخدم
  const fileName = `نموذج_طلب_صيانة_${request.id}.xlsx`;
  const outBuf = await wb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification('تم تصدير النموذج من التمبليت بنجاح!', 'success');
}

// Notification Helper
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Export Single PDF

// Export Single PDF (يدعم imageUrl من Drive بتحويلها إلى Base64)
async function exportSinglePDF(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  doc.setLanguage('ar');
  doc.setR2L(true);

  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('🔧', 15, 15);

  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(`نموذج أمر عمل (صيانة) - رقم ${request.id}`, doc.internal.pageSize.width / 2, 20, { align: 'center' });

  let y = 35;
  const lineHeight = 10;

  doc.setFontSize(11);
  doc.text(`رقم الطلب: ${request.id}`, 15, y); y += lineHeight;
  doc.text(`نوع الطلب: ${request.type}`, 15, y); y += lineHeight;
  doc.text(`المبنى: ${request.building}`, 15, y); y += lineHeight;
  doc.text(`نوع الصيانة: ${request.maintenanceType}`, 15, y); y += lineHeight;
  doc.text(`صاحب الطلب: ${request.requesterName}`, 15, y); y += lineHeight;
  doc.text(`التاريخ: ${request.date} - ${request.hijriDate}`, 15, y); y += lineHeight;
  doc.text(`الوقت: ${request.time}`, 15, y); y += lineHeight;
  doc.text(`اليوم: ${request.day}`, 15, y); y += lineHeight;
  doc.text(`نوع العطل: ${request.faultType}`, 15, y); y += lineHeight;
  doc.text(`وصف العطل: ${request.faultDescription}`, 15, y); y += lineHeight * 2;

  // --- الصورة: نحاول Base64 من request.image، ثم Drive عبر Apps Script، ثم المتصفح كاحتياط ---
  let imgData = request.image || '';
  if (!imgData && request.imageUrl) {
    // أولاً: اطلب من Apps Script (موثوق بدون CORS)
    imgData = await getDriveImageAsDataURL(request.imageUrl);
    // احتياط: جرّب التحويل داخل المتصفح إن فشل سكربتك أو لم يرجع Base64
    if (!imgData) {
      try { imgData = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }

  if (imgData && imgData.startsWith('data:image/')) {
    doc.text('صورة العطل:', 15, y); y += lineHeight;
    const format = imgData.startsWith('data:image/png') ? 'PNG' : 'JPEG';
    doc.addImage(imgData, format, 15, y, 80, 60);
    y += 70;
  }

  if (request.technicianName) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('تقرير الفني', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`اسم الفني: ${request.technicianName}`, 15, y); y += lineHeight;
    doc.text(`حالة العمل: ${request.workStatus}`, 15, y); y += lineHeight;
    doc.text(`ملاحظات الفني: ${request.technicianNotes}`, 15, y); y += lineHeight * 2;
  }

  if (request.supervisorName) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('مراجعة المشرف', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`اسم المشرف: ${request.supervisorName}`, 15, y); y += lineHeight;
    doc.text(`القرار: ${request.supervisorDecision}`, 15, y); y += lineHeight;
    doc.text(`ملاحظات المشرف: ${request.supervisorNotes}`, 15, y); y += lineHeight * 2;
  }

  if (request.isFixed) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('تقييم العميل', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`تم الإصلاح: ${request.isFixed}`, 15, y); y += lineHeight;
    doc.text(`مستوى الرضا: ${request.satisfactionLevel}`, 15, y); y += lineHeight;
    doc.text(`ملاحظات العميل: ${request.clientNotes || 'لا توجد'}`, 15, y);
  }

  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text('نظام إدارة الصيانة', doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });

  doc.save(`طلب_صيانة_${request.id}.pdf`);
}


// Print Report
function printReport() {
  window.print();
}

// Show Alert
function showAlert(elementId, message, type) {
  const alert = document.getElementById(elementId);
  alert.textContent = message;
  alert.className = `alert alert-${type}`;
  alert.style.display = 'block';
}

// Close Modal
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.classList.remove('active');
  }
};

// Storage Functions
function saveRequestsToStorage() {
  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
}

function loadRequestsFromStorage() {
  const stored = localStorage.getItem('maintenanceRequests');
  if (stored) {
    requests = JSON.parse(stored);
  }
}

// Auto-save and sync
setInterval(() => {
  if (currentUser && appsScriptUrl) {
    saveRequestsToStorage();
    // Optional: Auto-sync with Sheets
    // syncWithSheets();
  }
}, 30000);

// Update time every minute
setInterval(() => {
  if (currentUser) {
    setCurrentDateTime();
  }
}, 60000);

// زر مؤقت للمسح السريع
function clearLocalRequestsCache() {
  localStorage.removeItem('maintenanceRequests');
  requests = [];
  refreshAllTables();
  showNotification('تم مسح النسخة المحلية. حدّث/أعد تحميل الصفحة.', 'success');
}

</script>

</body>
</html>