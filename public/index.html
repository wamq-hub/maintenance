<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  direction: rtl;
}

/* Loading & Sync Indicator */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
  color: white;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.sync-indicator {
  position: fixed;
  top: 80px;
  left: 20px;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 1000;
  font-size: 0.9rem;
}

.sync-indicator.syncing {
  display: flex;
  color: #667eea;
}

.sync-indicator.success {
  display: flex;
  color: #27ae60;
}

.sync-indicator.error {
  display: flex;
  color: #e74c3c;
}

.sync-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(102, 126, 234, 0.3);
  border-top-color: #667eea;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Login Screen */
.login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.login-box h1 {
  color: #667eea;
  margin-bottom: 10px;
  font-size: 2rem;
}

.login-box .subtitle {
  color: #666;
  margin-bottom: 30px;
  font-size: 0.95rem;
}

.logo-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.input-group {
  margin-bottom: 20px;
  text-align: right;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
}

.input-group input:focus,
.input-group select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  margin-top: 10px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.sheets-config {
  margin-top: 25px;
  padding-top: 20px;
  border-top: 2px solid #eee;
  text-align: right;
}

.sheets-config h4 {
  color: #667eea;
  margin-bottom: 15px;
  font-size: 1rem;
}

.sheets-config small {
  display: block;
  color: #888;
  margin-top: 8px;
  line-height: 1.5;
}

/* User Info Bar */
.user-info-bar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px 30px;
  display: none;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.user-info {
  display: flex;
  align-items: center;
  gap: 20px;
}

.user-avatar {
  width: 45px;
  height: 45px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
}

.btn-logout {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  padding: 8px 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 500;
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

/* Container */
.container {
  max-width: 1400px;
  margin: 20px auto;
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  display: none;
}

.header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  text-align: center;
}

.header h1 {
  font-size: 2.2rem;
  margin-bottom: 10px;
}

.header p {
  opacity: 0.9;
  font-size: 1.05rem;
}

/* Navigation Tabs */
.nav-tabs {
  display: flex;
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
  overflow-x: auto;
}

.nav-tab {
  flex: 1;
  padding: 18px 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 500;
  color: #666;
  transition: all 0.3s;
  white-space: nowrap;
  position: relative;
}

.nav-tab:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
}

.nav-tab.active {
  color: #667eea;
  background: white;
}

.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Content */
.tab-content {
  display: none;
  padding: 30px;
  animation: fadeIn 0.3s;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Form Styling */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.form-group {
  text-align: right;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #333;
  font-weight: 500;
  font-size: 0.95rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  transition: all 0.3s;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group input:disabled {
  background: #f5f5f5;
  cursor: not-allowed;
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

/* Image Upload */
.image-upload-container {
  border: 2px dashed #e0e0e0;
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  cursor: pointer;
}

.image-upload-container:hover {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.image-upload-container.has-image {
  border-style: solid;
  border-color: #27ae60;
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 10px;
  color: #667eea;
}

.upload-text {
  color: #666;
  font-size: 0.95rem;
}

.image-preview {
  max-width: 100%;
  max-height: 300px;
  border-radius: 10px;
  margin-top: 15px;
  display: none;
}

.image-preview.show {
  display: block;
}

.remove-image-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  display: none;
}

.remove-image-btn.show {
  display: inline-block;
}

.remove-image-btn:hover {
  background: #c0392b;
}

/* Buttons */
.btn-primary {
  padding: 12px 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-secondary {
  padding: 12px 30px;
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  border-radius: 10px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-left: 10px;
}

.btn-secondary:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

.btn-success {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.btn-danger {
  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
}

/* Stats Cards */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  transition: transform 0.3s;
}

.stat-card:hover {
  transform: translateY(-5px);
}

.stat-card h3 {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.stat-card p {
  font-size: 1.1rem;
  opacity: 0.9;
}

/* Table */
.table-container {
  overflow-x: auto;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

thead {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

th {
  padding: 15px;
  text-align: right;
  font-weight: 600;
  font-size: 0.95rem;
}

td {
  padding: 15px;
  text-align: right;
  border-bottom: 1px solid #f0f0f0;
}

tbody tr:hover {
  background: #f8f9ff;
}

.status-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  display: inline-block;
}

.status-pending {
  background: #fff3cd;
  color: #856404;
}

.status-progress {
  background: #cfe2ff;
  color: #084298;
}

.status-completed {
  background: #d1e7dd;
  color: #0a3622;
}

.status-rejected {
  background: #f8d7da;
  color: #721c24;
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

.action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s;
}

.action-btn:hover {
  transform: scale(1.05);
}

.btn-view {
  background: #667eea;
  color: white;
}

.btn-edit {
  background: #38ef7d;
  color: white;
}

.btn-delete {
  background: #f45c43;
  color: white;
}

.btn-pdf {
  background: #e74c3c;
  color: white;
}

.btn-excel {
  background: #27ae60;
  color: white;
}

.btn-image {
  background: #3498db;
  color: white;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: 20px;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: modalSlideIn 0.3s;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-header h2 {
  color: #667eea;
  font-size: 1.8rem;
}

.close-modal {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}

.close-modal:hover {
  color: #333;
}

/* Alert Messages */
.alert {
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  font-weight: 500;
  display: none;
  animation: slideDown 0.3s;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(100px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideOut {
  from {
    opacity: 1;
    transform: translateX(0);
  }
  to {
    opacity: 0;
    transform: translateX(100px);
  }
}

.alert-success {
  background: #d1e7dd;
  color: #0a3622;
  border: 1px solid #a3cfbb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f1aeb5;
}

.alert-info {
  background: #cfe2ff;
  color: #084298;
  border: 1px solid #9ec5fe;
}

/* Image Modal */
.image-modal-content {
  max-width: 90vw;
  max-height: 90vh;
}

.image-modal-content img {
  width: 100%;
  height: auto;
  border-radius: 10px;
}

/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 1.6rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .stats-grid {
    grid-template-columns: 1fr;
  }

  .nav-tabs {
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .modal-content {
    padding: 20px;
  }

  .action-buttons {
    flex-direction: column;
  }

  table {
    font-size: 0.85rem;
  }

  th, td {
    padding: 10px 8px;
  }
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #5568d3;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <div class="spinner"></div>
  <p style="margin-top: 20px; font-size: 1.2rem;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
</div>

<!-- Sync Indicator -->
<div class="sync-indicator" id="syncIndicator">
  <div class="sync-spinner"></div>
  <span id="syncText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</span>
</div>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="logo-icon">ğŸ”§</div>
    <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</h1>
    <p class="subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</p>
    
    <form id="loginForm" onsubmit="login(event)">
      <div class="input-group">
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
        <input type="text" id="employeeId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" required>
      </div>
      
      <div class="input-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
      </div>
      
      <button type="submit" class="btn" id="loginBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
    
    <div class="sheets-config">
      <h4>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Sheets</h4>
      <div class="input-group">
        <label>Ø±Ø§Ø¨Ø· Google Apps Script</label>
        <input type="url" id="appsScriptUrl" 
               placeholder="https://script.google.com/macros/s/..."
               value="">
      </div>
      <small>
        ğŸ“ Ø§ØªØ¨Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ÙÙŠ Ù…Ù„Ù SETUP.md Ù„Ø¥Ù†Ø´Ø§Ø¡ Google Sheets ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
      </small>
    </div>
  </div>
</div>

<!-- User Info Bar -->
<div class="user-info-bar" id="userBar">
  <div class="user-info">
    <div class="user-avatar">ğŸ‘¤</div>
    <div>
      <div id="userName" style="font-weight: 600; font-size: 1.1rem;"></div>
      <div id="userRole" style="opacity: 0.9; font-size: 0.9rem;"></div>
    </div>
  </div>
  <button class="btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer">
  <div class="header">
    <h1>ğŸ”§ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</h1>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø£Ø¹Ø·Ø§Ù„</p>
  </div>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showTab('new-request')">ğŸ“ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    <button class="nav-tab" onclick="showTab('technician-report')">ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</button>
    <button class="nav-tab" onclick="showTab('supervisor-review')">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</button>
    <button class="nav-tab" onclick="showTab('client-feedback')">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <button class="nav-tab" onclick="showTab('quality-report')">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø©</button>
    <button class="btn-secondary" onclick="pullFromSheets()">â¬‡ï¸ Ø³Ø­Ø¨ Ù…Ù† Google Sheets</button>
    <button class="btn-secondary" onclick="clearLocalRequestsCache()">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</button>

  </div>

  <!-- Tab: New Request -->
  <div class="tab-content active" id="new-request">
    <h2 style="color: #667eea; margin-bottom: 25px;">ğŸ“ Ù†Ù…ÙˆØ°Ø¬ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</h2>
    
    <div class="alert alert-success" id="newRequestAlert"></div>
    
    <form id="newRequestForm" onsubmit="submitNewRequest(event)">
      <div class="form-grid">
        <div class="form-group">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</label>
          <input type="text" id="requestId" disabled>
        </div>
        
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
          <select id="requestType" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</option>
            <option value="Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
            <option value="Ù‡Ø§ØªÙ">Ù‡Ø§ØªÙ</option>
            <option value="Ø§ÙŠÙ…ÙŠÙ„">Ø§ÙŠÙ…ÙŠÙ„</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„Ù…Ø¨Ù†Ù‰</label>
          <input type="text" id="building" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£ÙˆÙ„" required>
        </div>
        
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
          <select id="maintenanceType" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©</option>
            <option value="ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©">ØµÙŠØ§Ù†Ø© Ø·Ø§Ø±Ø¦Ø©</option>
            <option value="ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©">ØµÙŠØ§Ù†Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ©</option>
            <option value="ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©">ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ©</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</label>
          <input type="text" id="requesterName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ÙˆÙ‚Øª</label>
          <input type="text" id="requestTime" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</label>
          <input type="text" id="requestDate" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</label>
          <input type="text" id="hijriDate" disabled>
        </div>
        
        <div class="form-group">
          <label>Ø§Ù„ÙŠÙˆÙ…</label>
          <input type="text" id="requestDay" disabled>
        </div>
        
        <div class="form-group">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</label>
          <select id="faultType" onchange="toggleOtherFault()" required>
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</option>
            <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ">ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ</option>
            <option value="ØªÙƒÙŠÙŠÙ">ØªÙƒÙŠÙŠÙ</option>
            <option value="Ø³Ø¨Ø§ÙƒØ©">Ø³Ø¨Ø§ÙƒØ©</option>
            <option value="Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª">Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        
        <div class="form-group hidden" id="otherFaultDiv">
          <label>Ø­Ø¯Ø¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</label>
          <input type="text" id="otherFault" placeholder="Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„">
        </div>
      </div>
      
      <div class="form-group">
        <label>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„</label>
        <textarea id="faultDescription" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ø¹Ø·Ù„..." required></textarea>
      </div>
      
      <div class="form-group">
        <label>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <div class="image-upload-container" id="uploadContainer" onclick="document.getElementById('imageUpload').click()">
          <div class="upload-icon">ğŸ“¸</div>
          <div class="upload-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</div>
          <div class="upload-text" style="font-size: 0.85rem; color: #999; margin-top: 5px;">
            (JPG, PNG, GIF - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2MB)
          </div>
          <img id="imagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
          <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
          <button type="button" class="remove-image-btn" id="removeImageBtn" onclick="event.stopPropagation(); removeImage()">
            âŒ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©
          </button>
        </div>
      </div>
      
      <button type="submit" class="btn-primary" id="submitRequestBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button type="reset" class="btn-secondary" onclick="resetForm()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
    </form>
  </div>

  <!-- Tab: Technician Report -->
  <div class="tab-content" id="technician-report">
    <h2 style="color: #667eea; margin-bottom: 25px;">ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h2>
    
    <div class="alert alert-success" id="technicianAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
            <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="pendingRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Supervisor Review -->
  <div class="tab-content" id="supervisor-review">
    <h2 style="color: #667eea; margin-bottom: 25px;">âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
    
    <div class="alert alert-success" id="supervisorAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
            <th>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="technicianReportsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Client Feedback -->
  <div class="tab-content" id="client-feedback">
    <h2 style="color: #667eea; margin-bottom: 25px;">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    
    <div class="alert alert-success" id="clientAlert"></div>
    
    <div class="table-container" style="margin-bottom: 30px;">
      <table>
        <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="approvedRequestsTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab: Quality Report -->
  <div class="tab-content" id="quality-report">
    <h2 style="color: #667eea; margin-bottom: 25px;">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="totalRequests">0</h3>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
      </div>
      <div class="stat-card">
        <h3 id="pendingRequests">0</h3>
        <p>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>
      </div>
      <div class="stat-card">
        <h3 id="completedRequests">0</h3>
        <p>Ø·Ù„Ø¨Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</p>
      </div>
      <div class="stat-card">
        <h3 id="rejectedRequests">0</h3>
        <p>Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</p>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <button class="btn-primary btn-excel" onclick="exportToExcel()">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
      <button class="btn-primary btn-success" onclick="exportAllWithTemplates()">ğŸ“‹ ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
      <button class="btn-primary btn-pdf" onclick="exportToPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
      <button class="btn-secondary" onclick="syncWithSheets()">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Sheets</button>
      <button class="btn-secondary" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
            <th>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„</th>
            <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙÙ†ÙŠ</th>
            <th>Ø§Ù„Ù…Ø´Ø±Ù</th>
            <th>ØµÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="allRequestsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modals will be added here by JavaScript -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Global Variables
let currentUser = null;
let requests = [];
let users = [];
let appsScriptUrl = '';
let uploadedImage = null;

// User Roles
const ROLES = {
  QUALITY_MANAGER: 'ÙˆÙƒÙŠÙ„ Ø¶Ø¨Ø· Ø§Ù„Ø¬ÙˆØ¯Ø©',
  SUPERVISOR: 'Ù…Ø´Ø±Ù Ø§Ù„ØµÙŠØ§Ù†Ø©',
  TECHNICIAN: 'ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©',
  EMPLOYEE: 'Ù…ÙˆØ¸Ù',
  DEAN: 'Ø§Ù„Ø¹Ù…ÙŠØ¯'
};

// Hijri Conversion
function toHijri(gregorianDate) {
  const gDate = new Date(gregorianDate);
  const gYear = gDate.getFullYear();
  const gMonth = gDate.getMonth() + 1;
  const gDay = gDate.getDate();
  
  const hYear = Math.floor((gYear - 622) * 1.030684);
  const hMonth = Math.floor((gMonth + (gDay / 30)) * 1.030684) % 12 || 12;
  const hDay = Math.floor((gDay * 1.030684) % 30) || 1;
  
  const arabicMonths = [
    'Ù…Ø­Ø±Ù…', 'ØµÙØ±', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„', 'Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰', 'Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©',
    'Ø±Ø¬Ø¨', 'Ø´Ø¹Ø¨Ø§Ù†', 'Ø±Ù…Ø¶Ø§Ù†', 'Ø´ÙˆØ§Ù„', 'Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©', 'Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©'
  ];
  
  return `${hDay} ${arabicMonths[hMonth - 1]} ${hYear}Ù‡Ù€`;
}

// Get Arabic Day
function getArabicDay(date) {
  const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
  return days[new Date(date).getDay()];
}

// Initialize
window.onload = function() {
  // Load saved Apps Script URL
  const savedUrl = localStorage.getItem('appsScriptUrl');
  if (savedUrl) {
    document.getElementById('appsScriptUrl').value = savedUrl;
    appsScriptUrl = savedUrl;
  }
  
  loadRequestsFromStorage();
  updateNextRequestId();
  setCurrentDateTime();
  
  // Check if user already logged in
  const savedUser = localStorage.getItem('currentUser');
  if (savedUser && appsScriptUrl) {
    currentUser = JSON.parse(savedUser);
    showMainApp();
  }
  
  // Hide loading screen
  setTimeout(() => {
    document.getElementById('loadingScreen').style.display = 'none';
  }, 1000);
  
  // Create modals
  createModals();
};

// Create Modals
function createModals() {
  const modalsHTML = `
    <!-- Technician Report Modal -->
    <div class="modal" id="technicianModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ”§ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h2>
          <button class="close-modal" onclick="closeModal('technicianModal')">&times;</button>
        </div>
        
        <form id="technicianForm" onsubmit="submitTechnicianReport(event)">
          <input type="hidden" id="techRequestId">
          
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</label>
            <input type="text" id="technicianName" required>
          </div>
          
          <div class="form-group">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„</label>
            <select id="workStatus" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
              <option value="ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
              <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
              <option value="ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
              <option value="ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±">ÙŠØ­ØªØ§Ø¬ Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ</label>
            <textarea id="technicianNotes" placeholder="Ø£Ø¶Ù Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          <button type="button" class="btn-secondary" onclick="closeModal('technicianModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- Supervisor Review Modal -->
    <div class="modal" id="supervisorModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>âœ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
          <button class="close-modal" onclick="closeModal('supervisorModal')">&times;</button>
        </div>
        
        <form id="supervisorForm" onsubmit="submitSupervisorReview(event)">
          <input type="hidden" id="supRequestId">
          
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù</label>
            <input type="text" id="supervisorName" required>
          </div>
          
          <div class="form-group">
            <label>Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù</label>
            <select id="supervisorDecision" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø±</option>
              <option value="Ù…Ø¹ØªÙ…Ø¯">Ù…Ø¹ØªÙ…Ø¯</option>
              <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
              <option value="ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©">ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù</label>
            <textarea id="supervisorNotes" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." required></textarea>
          </div>
          
          <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button type="button" class="btn-secondary" onclick="closeModal('supervisorModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- Client Feedback Modal -->
    <div class="modal" id="clientModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
          <button class="close-modal" onclick="closeModal('clientModal')">&times;</button>
        </div>
        
        <form id="clientForm" onsubmit="submitClientFeedback(event)">
          <input type="hidden" id="clientRequestId">
          
          <div class="form-group">
            <label>Ù‡Ù„ ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø·Ù„ØŸ</label>
            <select id="isFixed" required>
              <option value="">Ø§Ø®ØªØ±</option>
              <option value="Ù†Ø¹Ù…">Ù†Ø¹Ù…</option>
              <option value="Ù„Ø§">Ù„Ø§</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§</label>
            <select id="satisfactionLevel" required>
              <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§</option>
              <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø² â­â­â­â­â­</option>
              <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ â­â­â­â­</option>
              <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯ â­â­â­</option>
              <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„ â­â­</option>
              <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ â­</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <textarea id="clientNotes" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ø§ØªÙƒ..."></textarea>
          </div>
          
          <button type="submit" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
          <button type="button" class="btn-secondary" onclick="closeModal('clientModal')">Ø¥Ù„ØºØ§Ø¡</button>
        </form>
      </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="viewModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
          <button class="close-modal" onclick="closeModal('viewModal')">&times;</button>
        </div>
        <div id="viewDetailsContent"></div>
        <button class="btn-secondary" onclick="closeModal('viewModal')">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>

    <!-- Image Modal -->
    <div class="modal" id="imageModal">
      <div class="modal-content image-modal-content">
        <div class="modal-header">
          <h2>ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„</h2>
          <button class="close-modal" onclick="closeModal('imageModal')">&times;</button>
        </div>
        <img id="modalImage" style="width: 100%; height: auto; border-radius: 10px;" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„">
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalsHTML);
}

// Handle Image Upload
function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Check file size (max 2MB)
  if (file.size > 2 * 1024 * 1024) {
    alert('âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª');
    return;
  }
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('âŒ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ÙŠØ³ ØµÙˆØ±Ø©');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedImage = e.target.result;
    document.getElementById('imagePreview').src = uploadedImage;
    document.getElementById('imagePreview').classList.add('show');
    document.getElementById('removeImageBtn').classList.add('show');
    document.getElementById('uploadContainer').classList.add('has-image');
  };
  reader.readAsDataURL(file);
}

// Remove Image
function removeImage() {
  uploadedImage = null;
  document.getElementById('imageUpload').value = '';
  document.getElementById('imagePreview').classList.remove('show');
  document.getElementById('removeImageBtn').classList.remove('show');
  document.getElementById('uploadContainer').classList.remove('has-image');
}

// View Image
function viewImage(imageData) {
  if (!imageData) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©');
    return;
  }
  document.getElementById('modalImage').src = imageData;
  document.getElementById('imageModal').classList.add('active');
}

// Google Sheets Integration
async function callAppsScript(action, data) {
  if (!appsScriptUrl) return null;

  showSyncIndicator('syncing');
  try {
    const res = await fetch(appsScriptUrl, {
      method: 'POST',
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ØªØ¶Ù Content-Type: application/json Ø¹Ø´Ø§Ù† Ù†ØªØ¬Ù†Ø¨ preflight
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action, data })
    });

    if (!res.ok) {
      const text = await res.text();
      console.error('HTTP', res.status, text);
      showSyncIndicator('error');
      alert(`ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨: ${res.status}`);
      return null;
    }

    const json = await res.json();  // Apps Script ÙŠØ±Ø¬Ø¹ JSON Ø¹Ø¨Ø± ContentService
    showSyncIndicator((json && (json.ok === false || json.success === false)) ? 'error' : 'success');
    return json;
  } catch (err) {
    console.error('Fetch error:', err);
    showSyncIndicator('error');
    alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø³Ø­Ø¨ (ØªØ­Ù‚Ù‚ Ù…Ù† /exec ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª). Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Console.');
    return null;
  }
}

// ÙŠØ­ÙˆÙ‘Ù„ ØµÙÙˆÙ Ø§Ù„Ø´ÙŠØª (Ø±Ø¤ÙˆØ³ Ø¹Ø±Ø¨ÙŠØ©) Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ù…ÙØ§ØªÙŠØ­ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©)
function normalizeDriveImageUrl(url) {
  if (!url) return '';
  // Ø£Ù†Ù…Ø§Ø· Ø±ÙˆØ§Ø¨Ø· Drive Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
  const byFile = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  const byOpen = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
  const byUc   = url.match(/drive\.google\.com\/uc\?id=([^&]+)/);
  const id = (byFile?.[1]) || (byOpen?.[1]) || (byUc?.[1]) || null;
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : url;
}

// ===== helpers for Drive images =====

// ÙŠØ³ØªØ®Ø±Ø¬ fileId Ù…Ù† Ø£ÙŠ Ø´ÙƒÙ„ Ø±Ø§Ø¨Ø· Drive
function extractDriveId(url){
  if (!url) return null;
  const byFile = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  const byOpen = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
  const byUc   = url.match(/drive\.google\.com\/uc\?(?:export=\w+&)?id=([^&]+)/);
  return (byFile?.[1]) || (byOpen?.[1]) || (byUc?.[1]) || null;
}

// ÙŠØ·Ù„Ø¨ Ù…Ù† Apps Script ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Drive Ø¥Ù„Ù‰ dataURL (Base64)
// ÙŠØªØ·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ´Ù† getImageBase64 ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ù†Ø¸Ø± Ø§Ù„Ù‚Ø³Ù… 3 Ø¨Ø§Ù„Ø£Ø³ÙÙ„)
async function getDriveImageAsDataURL(url){
  const id = extractDriveId(url);
  if (!id) return null;
  const res = await callAppsScript('getImageBase64', { fileId: id });
  return (res && res.success && res.dataUrl) ? res.dataUrl : null;
}

// Ø¨Ø¯ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ (Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ CORS Ù…Ø¹ Ø±ÙˆØ§Ø¨Ø· Drive)
async function urlToDataURL(url) {
  const res = await fetch(url);  // Ù‚Ø¯ ÙŠØ±Ù…ÙŠ CORS
  const blob = await res.blob();
  return await new Promise((resolve) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result); // data:image/...;base64,...
    fr.readAsDataURL(blob);
  });
}

function mapArabicRowToModel(ar) {
  const rawUrl = ar['Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©'] || '';
  return {
    id: (ar['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨'] || '').toString(),
    type: ar['Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨'] || '',
    building: ar['Ø§Ù„Ù…Ø¨Ù†Ù‰'] || '',
    maintenanceType: ar['Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©'] || '',
    requesterName: ar['Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨'] || '',
    time: ar['Ø§Ù„ÙˆÙ‚Øª'] || '',
    date: ar['Ø§Ù„ØªØ§Ø±ÙŠØ®'] || '',
    hijriDate: ar['Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ'] || '',
    day: ar['Ø§Ù„ÙŠÙˆÙ…'] || '',
    faultType: ar['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„'] || '',
    faultDescription: ar['ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„'] || '',
    imageUrl: normalizeDriveImageUrl(rawUrl), // â† Ù‡Ù†Ø§
    status: ar['Ø§Ù„Ø­Ø§Ù„Ø©'] || 'Ù…Ø¹Ù„Ù‚',
    technicianName: ar['Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ'] || '',
    workStatus: ar['Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„'] || '',
    technicianNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ'] || '',
    supervisorName: ar['Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    supervisorDecision: ar['Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    supervisorNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù'] || '',
    isFixed: ar['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'] || '',
    satisfactionLevel: ar['Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§'] || '',
    clientNotes: ar['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '',
    createdAt: ar['ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡'] || ''
  };
}



// Show Sync Indicator
function showSyncIndicator(status) {
  const indicator = document.getElementById('syncIndicator');
  const text = document.getElementById('syncText');

  // Ø£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø¤Ø´Ù‘Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø£ÙˆÙ„Ù‹Ø§
  indicator.style.display = 'flex';
  indicator.className = 'sync-indicator ' + status;

  if (status === 'syncing') {
    text.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';
  } else if (status === 'success') {
    text.textContent = 'âœ“ ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­';
  } else if (status === 'error') {
    text.textContent = 'âœ— ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
  }

  // Ø£Ø®ÙÙÙ‡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù ÙÙŠ Ø­Ø§Ù„ success/error ÙÙ‚Ø·
  if (status !== 'syncing') {
    setTimeout(() => {
      indicator.style.display = 'none';
    }, 3000);
  }
}


// Sync with Sheets
async function syncWithSheets() {
  if (!appsScriptUrl) {
    alert('âš ï¸ ÙŠØ¬Ø¨ ØªÙƒÙˆÙŠÙ† Ø±Ø§Ø¨Ø· Google Apps Script Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  
  showSyncIndicator('syncing');
  
  // Save all requests to Sheets
  for (const request of requests) {
    await callAppsScript('addRequest', request);
  }
  
  alert('âœ“ ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Sheets Ø¨Ù†Ø¬Ø§Ø­!');
}

async function pullFromSheets() {
  if (!appsScriptUrl) {
    alert('âš ï¸ Ø§Ø¶Ø¨Ø· Ø±Ø§Ø¨Ø· Google Apps Script Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }
  showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Google Sheets...', 'info');

  const res = await callAppsScript('getRequests', {});
  if (!res) { alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø³Ø­Ø¨'); return; }

  // Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ¹ÙŠØ¯ {success:true, data:[...]}
  const rows = (res.data || []);
  if (!Array.isArray(rows)) {
    alert('ØµÙŠØºØ© Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø´ÙŠØª');
    return;
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  requests = rows.map(mapArabicRowToModel);

  saveRequestsToStorage();
  refreshAllTables();
  showNotification(`ØªÙ… Ø§Ù„Ø³Ø­Ø¨ØŒ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: ${requests.length}`, 'success');
}



// Login
async function login(e) {
  e.preventDefault();
  
  const employeeId = document.getElementById('employeeId').value;
  const password = document.getElementById('password').value;
  const scriptUrl = document.getElementById('appsScriptUrl').value;
  
  if (!scriptUrl) {
    alert('âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Google Apps Script');
    return;
  }
  
  // Save Apps Script URL
  appsScriptUrl = scriptUrl;
  localStorage.setItem('appsScriptUrl', scriptUrl);
  
  // Disable login button
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
  
  try {
    // Try to fetch users from Sheets
    // Note: In real implementation, you'd make actual API call
    // For now, we'll use demo users
    
    const demoUsers = [
      { id: '000001', password: 'quality123', name: 'Ù…. ÙÙ‡Ø¯ ØµØ§Ù„Ø­', role: ROLES.QUALITY_MANAGER },
      { id: '000002', password: 'supervisor123', name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', role: ROLES.SUPERVISOR },
      { id: '000003', password: 'technician123', name: 'Ø®Ø§Ù„Ø¯ Ø¹Ù„ÙŠ', role: ROLES.TECHNICIAN },
      { id: '000004', password: 'employee123', name: 'Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯', role: ROLES.EMPLOYEE },
      { id: '000005', password: 'dean123', name: 'Ø¯. Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ', role: ROLES.DEAN }
    ];
    
    const user = demoUsers.find(u => u.id === employeeId && u.password === password);
    
    if (user) {
      currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(user));
      showMainApp();
    } else {
      alert('âŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      loginBtn.disabled = false;
      loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
    }
  } catch (error) {
    console.error('Login error:', error);
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    loginBtn.disabled = false;
    loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
  }
}

// Logout
function logout() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
  }
}

// Show Main App
function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('userBar').style.display = 'flex';
  document.getElementById('mainContainer').style.display = 'block';
  
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userRole').textContent = currentUser.role;
  
  setupPermissions();
  refreshAllTables();
}

// Setup Permissions
function setupPermissions() {
  const tabs = document.querySelectorAll('.nav-tab');
  
  tabs.forEach(tab => tab.style.display = 'none');
  
  if (currentUser.role === ROLES.QUALITY_MANAGER || currentUser.role === ROLES.DEAN) {
    tabs.forEach(tab => tab.style.display = 'block');
  } else if (currentUser.role === ROLES.SUPERVISOR) {
    ['new-request', 'supervisor-review', 'quality-report'].forEach(tabId => {
      document.querySelector(`[onclick="showTab('${tabId}')"]`).style.display = 'block';
    });
    showTab('supervisor-review');
  } else if (currentUser.role === ROLES.TECHNICIAN) {
    document.querySelector(`[onclick="showTab('technician-report')"]`).style.display = 'block';
    showTab('technician-report');
  } else if (currentUser.role === ROLES.EMPLOYEE) {
    ['new-request', 'client-feedback'].forEach(tabId => {
      document.querySelector(`[onclick="showTab('${tabId}')"]`).style.display = 'block';
    });
  }
}

// Show Tab
function showTab(tabId) {
  document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  event.target.classList.add('active');
  document.getElementById(tabId).classList.add('active');
  
  refreshAllTables();
}

// Set Current DateTime
function setCurrentDateTime() {
  const now = new Date();
  const time = now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('ar-SA');
  const hijri = toHijri(now);
  const day = getArabicDay(now);
  
  document.getElementById('requestTime').value = time;
  document.getElementById('requestDate').value = date;
  document.getElementById('hijriDate').value = hijri;
  document.getElementById('requestDay').value = day;
}

// Update Request ID
function updateNextRequestId() {
  const nextId = (requests.length + 1).toString().padStart(6, '0');
  document.getElementById('requestId').value = nextId;
}

// Toggle Other Fault
function toggleOtherFault() {
  const faultType = document.getElementById('faultType').value;
  const otherDiv = document.getElementById('otherFaultDiv');
  
  if (faultType === 'Ø£Ø®Ø±Ù‰') {
    otherDiv.classList.remove('hidden');
    document.getElementById('otherFault').required = true;
  } else {
    otherDiv.classList.add('hidden');
    document.getElementById('otherFault').required = false;
  }
}

// Reset Form
function resetForm() {
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
}

// Submit New Request
async function submitNewRequest(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitRequestBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  
  const faultType = document.getElementById('faultType').value;
  const finalFaultType = faultType === 'Ø£Ø®Ø±Ù‰' ? document.getElementById('otherFault').value : faultType;
  
  const request = {
    id: document.getElementById('requestId').value,
    type: document.getElementById('requestType').value,
    building: document.getElementById('building').value,
    maintenanceType: document.getElementById('maintenanceType').value,
    requesterName: document.getElementById('requesterName').value,
    time: document.getElementById('requestTime').value,
    date: document.getElementById('requestDate').value,
    hijriDate: document.getElementById('hijriDate').value,
    day: document.getElementById('requestDay').value,
    faultType: finalFaultType,
    faultDescription: document.getElementById('faultDescription').value,
    image: uploadedImage || '',
    status: 'Ù…Ø¹Ù„Ù‚',
    createdAt: new Date().toISOString(),
    createdBy: currentUser.name
  };
  
  requests.push(request);
  saveRequestsToStorage();
  
  // Send to Google Sheets
  const addRes = await callAppsScript('addRequest', request);
    // Ø¥Ø°Ø§ Ø£Ø¹Ø§Ø¯ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† DriveØŒ Ø®Ø²Ù‘Ù†Ù‡ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€base64 Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©
    if (addRes && addRes.imageUrl) {
      request.imageUrl = addRes.imageUrl;
      request.image = ''; // ØªÙØ§Ø¯ÙŠÙ‹Ø§ Ù„ØªØ®Ø²ÙŠÙ† base64 Ù…Ø­Ù„ÙŠÙ‹Ø§
      saveRequestsToStorage();
    }

  
  showAlert('newRequestAlert', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + request.id, 'success');
  
  document.getElementById('newRequestForm').reset();
  removeImage();
  updateNextRequestId();
  setCurrentDateTime();
  
  submitBtn.disabled = false;
  submitBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
  
  setTimeout(() => {
    document.getElementById('newRequestAlert').style.display = 'none';
  }, 5000);
}

// Open Technician Modal
function openTechnicianModal(requestId) {
  document.getElementById('techRequestId').value = requestId;
  document.getElementById('technicianName').value = currentUser.name;
  document.getElementById('technicianModal').classList.add('active');
}

// Submit Technician Report
async function submitTechnicianReport(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('techRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.technicianName = document.getElementById('technicianName').value;
    request.workStatus = document.getElementById('workStatus').value;
    request.technicianNotes = document.getElementById('technicianNotes').value;
    request.status = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    request.techUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('technicianModal');
    showAlert('technicianAlert', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    refreshAllTables();
    
    document.getElementById('technicianForm').reset();
    
    setTimeout(() => {
      document.getElementById('technicianAlert').style.display = 'none';
    }, 3000);
  }
}

// Open Supervisor Modal
function openSupervisorModal(requestId) {
  document.getElementById('supRequestId').value = requestId;
  document.getElementById('supervisorName').value = currentUser.name;
  document.getElementById('supervisorModal').classList.add('active');
}

// Submit Supervisor Review
async function submitSupervisorReview(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('supRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.supervisorName = document.getElementById('supervisorName').value;
    request.supervisorDecision = document.getElementById('supervisorDecision').value;
    request.supervisorNotes = document.getElementById('supervisorNotes').value;
    
    if (request.supervisorDecision === 'Ù…Ø¹ØªÙ…Ø¯') {
      request.status = 'Ù…Ø¹ØªÙ…Ø¯';
    } else if (request.supervisorDecision === 'Ù…Ø±ÙÙˆØ¶') {
      request.status = 'Ù…Ø±ÙÙˆØ¶';
    } else {
      request.status = 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©';
    }
    
    request.supUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('supervisorModal');
    showAlert('supervisorAlert', 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    refreshAllTables();
    
    document.getElementById('supervisorForm').reset();
    
    setTimeout(() => {
      document.getElementById('supervisorAlert').style.display = 'none';
    }, 3000);
  }
}

// Open Client Modal
function openClientModal(requestId) {
  document.getElementById('clientRequestId').value = requestId;
  document.getElementById('clientModal').classList.add('active');
}

// Submit Client Feedback
async function submitClientFeedback(e) {
  e.preventDefault();
  
  const requestId = document.getElementById('clientRequestId').value;
  const request = requests.find(r => r.id === requestId);
  
  if (request) {
    request.isFixed = document.getElementById('isFixed').value;
    request.satisfactionLevel = document.getElementById('satisfactionLevel').value;
    request.clientNotes = document.getElementById('clientNotes').value;
    request.status = request.isFixed === 'Ù†Ø¹Ù…' ? 'Ù…ÙƒØªÙ…Ù„' : 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
    request.clientUpdatedAt = new Date().toISOString();
    
    saveRequestsToStorage();
    await callAppsScript('updateRequest', request);
    
    closeModal('clientModal');
    showAlert('clientAlert', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ', 'success');
    refreshAllTables();
    
    document.getElementById('clientForm').reset();
    
    setTimeout(() => {
      document.getElementById('clientAlert').style.display = 'none';
    }, 3000);
  }
}

// View Request Details
function viewRequest(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;
  
  let html = '<div style="text-align: right;">';
  html += '<h3 style="color: #667eea; margin-bottom: 20px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>';
  html += `<p><strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</strong> ${request.id}</p>`;
  html += `<p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:</strong> ${request.type}</p>`;
  html += `<p><strong>Ø§Ù„Ù…Ø¨Ù†Ù‰:</strong> ${request.building}</p>`;
  html += `<p><strong>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©:</strong> ${request.maintenanceType}</p>`;
  html += `<p><strong>ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨:</strong> ${request.requesterName}</p>`;
  html += `<p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${request.date} - ${request.hijriDate}</p>`;
  html += `<p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${request.time}</p>`;
  html += `<p><strong>Ø§Ù„ÙŠÙˆÙ…:</strong> ${request.day}</p>`;
  html += `<p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„:</strong> ${request.faultType}</p>`;
  html += `<p><strong>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„:</strong> ${request.faultDescription}</p>`;
  
const _img = request.imageUrl || request.image;
if (_img) {
  html += `<p><strong>ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„:</strong><br><img src="${_img}" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin-top: 10px;" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„"></p>`;
}

  
  html += `<p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="status-badge status-${getStatusClass(request.status)}">${request.status}</span></p>`;
  
  if (request.technicianName) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ</h3>';
    html += `<p><strong>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ:</strong> ${request.technicianName}</p>`;
    html += `<p><strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„:</strong> ${request.workStatus}</p>`;
    html += `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ:</strong> ${request.technicianNotes}</p>`;
  }
  
  if (request.supervisorName) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù</h3>';
    html += `<p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù:</strong> ${request.supervisorName}</p>`;
    html += `<p><strong>Ø§Ù„Ù‚Ø±Ø§Ø±:</strong> ${request.supervisorDecision}</p>`;
    html += `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù:</strong> ${request.supervisorNotes}</p>`;
  }
  
  if (request.isFixed) {
    html += '<hr style="margin: 20px 0;"><h3 style="color: #667eea; margin-bottom: 15px;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>';
    html += `<p><strong>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­:</strong> ${request.isFixed}</p>`;
    html += `<p><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§:</strong> ${request.satisfactionLevel}</p>`;
    html += `<p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${request.clientNotes || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}</p>`;
  }
  
  html += '</div>';
  
  document.getElementById('viewDetailsContent').innerHTML = html;
  document.getElementById('viewModal').classList.add('active');
}

// Delete Request
async function deleteRequest(requestId) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
    requests = requests.filter(r => r.id !== requestId);
    saveRequestsToStorage();
    await callAppsScript('deleteRequest', { id: requestId });
    refreshAllTables();
    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
  }
}

// Get Status Class
function getStatusClass(status) {
  const statusMap = {
    'Ù…Ø¹Ù„Ù‚': 'pending',
    'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©': 'progress',
    'Ù…Ø¹ØªÙ…Ø¯': 'completed',
    'Ù…ÙƒØªÙ…Ù„': 'completed',
    'Ù…Ø±ÙÙˆØ¶': 'rejected',
    'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„': 'rejected',
    'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©': 'progress'
  };
  return statusMap[status] || 'pending';
}

// Refresh All Tables
function refreshAllTables() {
  refreshPendingRequestsTable();
  refreshTechnicianReportsTable();
  refreshApprovedRequestsTable();
  refreshAllRequestsTable();
  updateStatistics();
}

// Refresh Pending Requests Table
function refreshPendingRequestsTable() {
  const tbody = document.getElementById('pendingRequestsTable');
  const pendingRequests = requests.filter(r => r.status === 'Ù…Ø¹Ù„Ù‚');
  
  if (pendingRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
    return;
  }
  
  tbody.innerHTML = pendingRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-pending">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ø¹Ø±Ø¶</button>
          <button class="action-btn btn-edit" onclick="openTechnicianModal('${req.id}')">Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Technician Reports Table
function refreshTechnicianReportsTable() {
  const tbody = document.getElementById('technicianReportsTable');
  const reportedRequests = requests.filter(r => r.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©');
  
  if (reportedRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</td></tr>';
    return;
  }
  
  tbody.innerHTML = reportedRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.technicianName || '-'}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-progress">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ø¹Ø±Ø¶</button>
          <button class="action-btn btn-edit" onclick="openSupervisorModal('${req.id}')">Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Refresh Approved Requests Table
function refreshApprovedRequestsTable() {
  const tbody = document.getElementById('approvedRequestsTable');
  const approvedRequests = requests.filter(r => r.status === 'Ù…Ø¹ØªÙ…Ø¯');
  
  if (approvedRequests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…</td></tr>';
    return;
  }
  
  tbody.innerHTML = approvedRequests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.date}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-completed">${req.status}</span></td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ø¹Ø±Ø¶</button>
          <button class="action-btn btn-edit" onclick="openClientModal('${req.id}')">ØªÙ‚ÙŠÙŠÙ…</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// === Template via relative URL ===
const TEMPLATE_URL = './templates/maintenance_template.xlsx';

// Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ â† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ)
const TEMPLATE_CELL_MAP = {
  'C8':   r => r.id,
  'F8':   r => r.type,
  'I8':   r => r.building,
  'D9':   r => r.maintenanceType,
  'D11':  r => r.requesterName,
  'D13':  r => r.time,
  'H13':  r => r.date,             // Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
  'C15':  r => r.faultType,
  'A19':  r => r.faultDescription,
  'C25':  r => r.technicianName || '',
  'H26':  r => r.techDate || r.date || '',
  'C29':  r => r.supervisorName || '',
  'C30':  r => r.status || '',
  'H31':  r => r.supDate || r.date || '',
  'C34':  r => r.requesterName || '',
  'C35':  r => r.isFixed || '',
  'H36':  r => r.clientDate || r.date || ''
};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª Ù…Ù† Ù…Ù„Ù Ù…Ø¬Ø§ÙˆØ± (ÙˆÙŠÙØ®Ø²Ù‘Ù† Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
let __templateArrayBuffer = null;
async function loadTemplateArrayBuffer() {
  if (__templateArrayBuffer) return __templateArrayBuffer;
  const res = await fetch(TEMPLATE_URL);
  if (!res.ok) throw new Error('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª');
  __templateArrayBuffer = await res.arrayBuffer();
  return __templateArrayBuffer;
}

function dataURLToBase64(dataURL) {
  return (dataURL || '').split(',')[1] || '';
}

// ØªØ¹Ø¨Ø¦Ø© Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
function fillTemplateCells(ws, request) {
  for (const cell in TEMPLATE_CELL_MAP) {
    const getter = TEMPLATE_CELL_MAP[cell];
    const val = (typeof getter === 'function') ? getter(request) : (request[getter] ?? '');
    const c = ws.getCell(cell);
    c.value = (val == null ? '' : val);
    c.alignment = Object.assign({}, c.alignment, { readingOrder: 'rtl' });
  }
}

// Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ ÙÙŠ Ù†Ø·Ø§Ù‚ Ù…Ø­Ø¯Ø¯ (Ø§Ø¶Ø¨Ø· Ø§Ù„Ù…ÙƒØ§Ù† Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ)
// Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª (ÙŠØ¯Ø¹Ù… imageUrl Ø¹Ø¨Ø± Apps Script)
async function tryInsertFaultImage(wb, ws, request) {
  // Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ dataURL Ø§Ù„Ù…Ø®Ø²Ù‘Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§
  let dataUrl = request.image || '';
  // Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± ÙˆØ­ØµÙ„Ù†Ø§ Ø¹Ù„Ù‰ imageUrl Ù…Ù† DriveØŒ Ø­ÙˆÙ‘Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Base64
  if (!dataUrl && request.imageUrl) {
    dataUrl = await getDriveImageAsDataURL(request.imageUrl);
    if (!dataUrl) {
      try { dataUrl = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }
  if (!dataUrl) return; // Ù„Ø§ ØµÙˆØ±Ø©

  try {
    const base64 = (dataUrl.split(',')[1] || '');
    const ext = dataUrl.startsWith('data:image/png') ? 'png' : 'jpeg';
    const imgId = wb.addImage({ base64, extension: ext });
    // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø­Ø³Ø¨ ØªÙ…Ø¨Ù„ÙŠØªÙƒ
    ws.addImage(imgId, { tl: { col: 7, row: 18 }, br: { col: 11, row: 28 } });
  } catch (e) {
    console.warn('ØªØ¹Ø°Ù‘Ø± Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª:', e);
  }
}



// Refresh All Requests Table
function refreshAllRequestsTable() {
  const tbody = document.getElementById('allRequestsTable');
  
  if (requests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 30px; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
    return;
  }
  
  tbody.innerHTML = requests.map(req => `
    <tr>
      <td>${req.id}</td>
      <td>${req.requesterName}</td>
      <td>${req.faultType}</td>
      <td>${req.building}</td>
      <td>${req.date}</td>
      <td>${req.technicianName || '-'}</td>
      <td>${req.supervisorName || '-'}</td>
      <td>${(req.imageUrl || req.image) ? '<button class="action-btn btn-image" onclick="viewImage(\'' + (req.imageUrl || req.image) + '\')">ğŸ“·</button>' : '-'}</td>
      <td><span class="status-badge status-${getStatusClass(req.status)}">${req.status}</span></td>
      <td>${req.satisfactionLevel || '-'}</td>
      <td>
        <div class="action-buttons">
          <button class="action-btn btn-view" onclick="viewRequest('${req.id}')">Ø¹Ø±Ø¶</button>
          <button class="action-btn btn-excel" onclick="exportWithTemplate('${req.id}')" title="ØªØµØ¯ÙŠØ± Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬">ğŸ“‹ Ù†Ù…ÙˆØ°Ø¬</button>
          <button class="action-btn btn-pdf" onclick="exportSinglePDF('${req.id}')">PDF</button>
          <button class="action-btn btn-delete" onclick="deleteRequest('${req.id}')">Ø­Ø°Ù</button>
        </div>
      </td>
    </tr>
  `).join('');
}

// Update Statistics
function updateStatistics() {
  document.getElementById('totalRequests').textContent = requests.length;
  document.getElementById('pendingRequests').textContent = requests.filter(r => r.status === 'Ù…Ø¹Ù„Ù‚' || r.status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©').length;
  document.getElementById('completedRequests').textContent = requests.filter(r => r.status === 'Ù…ÙƒØªÙ…Ù„' || r.status === 'Ù…Ø¹ØªÙ…Ø¯').length;
  document.getElementById('rejectedRequests').textContent = requests.filter(r => r.status === 'Ù…Ø±ÙÙˆØ¶' || r.status === 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„').length;
}

// Export to Excel
function exportToExcel() {
  if (requests.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  const data = requests.map(req => ({
    'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨': req.id,
    'ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨': req.requesterName,
    'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨': req.type,
    'Ø§Ù„Ù…Ø¨Ù†Ù‰': req.building,
    'Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©': req.maintenanceType,
    'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„': req.faultType,
    'ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„': req.faultDescription,
    'Ø§Ù„ØªØ§Ø±ÙŠØ®': req.date,
    'Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ': req.hijriDate,
    'Ø§Ù„ÙˆÙ‚Øª': req.time,
    'Ø§Ù„ÙŠÙˆÙ…': req.day,
    'Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ': req.technicianName || '-',
    'Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„': req.workStatus || '-',
    'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù': req.supervisorName || '-',
    'Ù‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø±Ù': req.supervisorDecision || '-',
    'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­': req.isFixed || '-',
    'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§': req.satisfactionLevel || '-',
    'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©': req.status,
    'ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±Ø©': (req.imageUrl || req.image) ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'
  }));
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø©');
  
  const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// Export to PDF
function exportToPDF() {
  if (requests.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');
  
  doc.setLanguage('ar');
  doc.setR2L(true);
  
  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('ğŸ”§', 15, 15);
  
  doc.setFontSize(18);
  doc.setTextColor(0, 0, 0);
  doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø´Ø§Ù…Ù„', doc.internal.pageSize.width / 2, 20, { align: 'center' });
  
  doc.setFontSize(12);
  doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-SA')}`, doc.internal.pageSize.width - 15, 15, { align: 'right' });
  
  const tableData = requests.map(req => [
    req.id,
    req.requesterName,
    req.faultType,
    req.building,
    req.date,
    req.technicianName || '-',
    req.supervisorName || '-',
    req.status,
    (req.imageUrl || req.image) ? 'âœ“' : '-'
  ]);
  
  doc.autoTable({
    startY: 30,
    head: [['Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨', 'Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„', 'Ø§Ù„Ù…Ø¨Ù†Ù‰', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙÙ†ÙŠ', 'Ø§Ù„Ù…Ø´Ø±Ù', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ØµÙˆØ±Ø©']],
    body: tableData,
    styles: {
      font: 'helvetica',
      fontSize: 10,
      halign: 'center'
    },
    headStyles: {
      fillColor: [102, 126, 234],
      textColor: 255,
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [245, 245, 250]
    }
  });
  
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(
      `ØµÙØ­Ø© ${i} Ù…Ù† ${pageCount}`,
      doc.internal.pageSize.width / 2,
      doc.internal.pageSize.height - 10,
      { align: 'center' }
    );
  }
  
  const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.pdf`;
  doc.save(fileName);
}

// Export All Requests with Templates
async function exportAllWithTemplates() {
  if (requests.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

  showNotification('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬...', 'info');

  // Ø­Ù…Ù‘Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
  const ab = await loadTemplateArrayBuffer();
  const baseWb = new ExcelJS.Workbook();
  await baseWb.xlsx.load(ab);
  const baseSheet = baseWb.worksheets[0];

  // Ù…Ù„Ù Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬
  const outWb = new ExcelJS.Workbook();

  for (const req of requests) {
    // Ø£Ø¶Ù ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ù„Ø¨
    const ws = outWb.addWorksheet(`Ø·Ù„Ø¨_${req.id}`.substring(0,31));

    // Ø§Ù†Ø³Ø® Ù‡ÙŠÙƒÙ„ ÙˆØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª (ØµÙØ§Ù‹ Ø¨ØµÙ)
    baseSheet.eachRow({ includeEmpty: true }, (row, r) => {
      const newRow = ws.getRow(r);
      row.eachCell({ includeEmpty: true }, (cell, c) => {
        const nc = newRow.getCell(c);
        nc.value = cell.value;
        if (cell.style) nc.style = JSON.parse(JSON.stringify(cell.style));
      });
      newRow.height = row.height;
    });
    // Ø§Ù†Ø³Ø® Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    if (baseSheet.columns) {
      ws.columns = baseSheet.columns.map(col => ({ width: col.width }));
    }

    // Ø¹Ø¨Ù‘Ø¦ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    fillTemplateCells(ws, req);

    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„
    await tryInsertFaultImage(outWb, ws, req);
  }

  // Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù
  const fileName = `Ù†Ù…Ø§Ø°Ø¬_Ø§Ù„ØµÙŠØ§Ù†Ø©_${new Date().toLocaleDateString('ar-SA').replace(/\//g, '-')}.xlsx`;
  const outBuf = await outWb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification(`ØªÙ… ØªØµØ¯ÙŠØ± ${requests.length} Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª!`, 'success');
}

// Export Single Request with Template
async function exportWithTemplate(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) { alert('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

  showNotification('Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...', 'info');

  // 1) Ø­Ù…Ù„ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
  const ab = await loadTemplateArrayBuffer();

  // 2) Ø§ÙØªØ­ Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(ab);

  // 3) Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„ÙˆØ±Ù‚Ø© Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ø³Ù… Ù…Ø­Ø¯Ø¯)
  const ws = wb.worksheets[0]; // Ø£Ùˆ wb.getWorksheet('Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµÙŠØ§Ù†Ø©');

  // 4) Ø¹Ø¨Ù‘Ø¦ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
  fillTemplateCells(ws, request);

  // 5) (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ø£Ø¯Ø±Ø¬ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„ ÙÙŠ Ù…ÙƒØ§Ù†Ù‡Ø§
  await tryInsertFaultImage(wb, ws, request);

  // 6) Ø­Ù…Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const fileName = `Ù†Ù…ÙˆØ°Ø¬_Ø·Ù„Ø¨_ØµÙŠØ§Ù†Ø©_${request.id}.xlsx`;
  const outBuf = await wb.xlsx.writeBuffer();
  const blob = new Blob([outBuf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fileName;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);

  showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† Ø§Ù„ØªÙ…Ø¨Ù„ÙŠØª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

// Notification Helper
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    font-weight: 500;
  `;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Export Single PDF

// Export Single PDF (ÙŠØ¯Ø¹Ù… imageUrl Ù…Ù† Drive Ø¨ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Base64)
async function exportSinglePDF(requestId) {
  const request = requests.find(r => r.id === requestId);
  if (!request) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');

  doc.setLanguage('ar');
  doc.setR2L(true);

  doc.setFontSize(20);
  doc.setTextColor(102, 126, 234);
  doc.text('ğŸ”§', 15, 15);

  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text(`Ù†Ù…ÙˆØ°Ø¬ Ø£Ù…Ø± Ø¹Ù…Ù„ (ØµÙŠØ§Ù†Ø©) - Ø±Ù‚Ù… ${request.id}`, doc.internal.pageSize.width / 2, 20, { align: 'center' });

  let y = 35;
  const lineHeight = 10;

  doc.setFontSize(11);
  doc.text(`Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${request.id}`, 15, y); y += lineHeight;
  doc.text(`Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: ${request.type}`, 15, y); y += lineHeight;
  doc.text(`Ø§Ù„Ù…Ø¨Ù†Ù‰: ${request.building}`, 15, y); y += lineHeight;
  doc.text(`Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø©: ${request.maintenanceType}`, 15, y); y += lineHeight;
  doc.text(`ØµØ§Ø­Ø¨ Ø§Ù„Ø·Ù„Ø¨: ${request.requesterName}`, 15, y); y += lineHeight;
  doc.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${request.date} - ${request.hijriDate}`, 15, y); y += lineHeight;
  doc.text(`Ø§Ù„ÙˆÙ‚Øª: ${request.time}`, 15, y); y += lineHeight;
  doc.text(`Ø§Ù„ÙŠÙˆÙ…: ${request.day}`, 15, y); y += lineHeight;
  doc.text(`Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ù„: ${request.faultType}`, 15, y); y += lineHeight;
  doc.text(`ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„: ${request.faultDescription}`, 15, y); y += lineHeight * 2;

  // --- Ø§Ù„ØµÙˆØ±Ø©: Ù†Ø­Ø§ÙˆÙ„ Base64 Ù…Ù† request.imageØŒ Ø«Ù… Drive Ø¹Ø¨Ø± Apps ScriptØŒ Ø«Ù… Ø§Ù„Ù…ØªØµÙØ­ ÙƒØ§Ø­ØªÙŠØ§Ø· ---
  let imgData = request.image || '';
  if (!imgData && request.imageUrl) {
    // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ø·Ù„Ø¨ Ù…Ù† Apps Script (Ù…ÙˆØ«ÙˆÙ‚ Ø¨Ø¯ÙˆÙ† CORS)
    imgData = await getDriveImageAsDataURL(request.imageUrl);
    // Ø§Ø­ØªÙŠØ§Ø·: Ø¬Ø±Ù‘Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¥Ù† ÙØ´Ù„ Ø³ÙƒØ±Ø¨ØªÙƒ Ø£Ùˆ Ù„Ù… ÙŠØ±Ø¬Ø¹ Base64
    if (!imgData) {
      try { imgData = await urlToDataURL(request.imageUrl); } catch(_) {}
    }
  }

  if (imgData && imgData.startsWith('data:image/')) {
    doc.text('ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø·Ù„:', 15, y); y += lineHeight;
    const format = imgData.startsWith('data:image/png') ? 'PNG' : 'JPEG';
    doc.addImage(imgData, format, 15, y, 80, 60);
    y += 70;
  }

  if (request.technicianName) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠ', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ: ${request.technicianName}`, 15, y); y += lineHeight;
    doc.text(`Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„: ${request.workStatus}`, 15, y); y += lineHeight;
    doc.text(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙÙ†ÙŠ: ${request.technicianNotes}`, 15, y); y += lineHeight * 2;
  }

  if (request.supervisorName) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù: ${request.supervisorName}`, 15, y); y += lineHeight;
    doc.text(`Ø§Ù„Ù‚Ø±Ø§Ø±: ${request.supervisorDecision}`, 15, y); y += lineHeight;
    doc.text(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù: ${request.supervisorNotes}`, 15, y); y += lineHeight * 2;
  }

  if (request.isFixed) {
    doc.setFontSize(13); doc.setTextColor(102, 126, 234);
    doc.text('ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ù…ÙŠÙ„', 15, y); y += lineHeight;
    doc.setFontSize(11); doc.setTextColor(0, 0, 0);
    doc.text(`ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ${request.isFixed}`, 15, y); y += lineHeight;
    doc.text(`Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±Ø¶Ø§: ${request.satisfactionLevel}`, 15, y); y += lineHeight;
    doc.text(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: ${request.clientNotes || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}`, 15, y);
  }

  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text('Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©', doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });

  doc.save(`Ø·Ù„Ø¨_ØµÙŠØ§Ù†Ø©_${request.id}.pdf`);
}


// Print Report
function printReport() {
  window.print();
}

// Show Alert
function showAlert(elementId, message, type) {
  const alert = document.getElementById(elementId);
  alert.textContent = message;
  alert.className = `alert alert-${type}`;
  alert.style.display = 'block';
}

// Close Modal
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// Close modal when clicking outside
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.classList.remove('active');
  }
};

// Storage Functions
function saveRequestsToStorage() {
  localStorage.setItem('maintenanceRequests', JSON.stringify(requests));
}

function loadRequestsFromStorage() {
  const stored = localStorage.getItem('maintenanceRequests');
  if (stored) {
    requests = JSON.parse(stored);
  }
}

// Auto-save and sync
setInterval(() => {
  if (currentUser && appsScriptUrl) {
    saveRequestsToStorage();
    // Optional: Auto-sync with Sheets
    // syncWithSheets();
  }
}, 30000);

// Update time every minute
setInterval(() => {
  if (currentUser) {
    setCurrentDateTime();
  }
}, 60000);

// Ø²Ø± Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø±ÙŠØ¹
function clearLocalRequestsCache() {
  localStorage.removeItem('maintenanceRequests');
  requests = [];
  refreshAllTables();
  showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©. Ø­Ø¯Ù‘Ø«/Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', 'success');
}

</script>

</body>
</html>